(self.webpackChunkcpmanager=self.webpackChunkcpmanager||[]).push([[469],{7469:(e,t,r)=>{var o;(o=CPManager).vouchers={selectedVouchers:new Set,currentlyVisibleVouchers:[],displayProviderZoneLinkage:async function(){const e=o.elements.providerZoneLinkageDetails;if(e){e.innerHTML='<p class="text-muted-foreground"><i class="fas fa-spinner fa-spin mr-2"></i>Loading linkage information...</p>';try{if(0===o.state.zones.allConfigured.length&&await o.zones.fetchAllZoneData(),0===o.state.vouchers.cachedProviders.length){const e=await o.api.callApi("/voucher/list_providers");o.state.vouchers.cachedProviders=Array.isArray(e)?e:[]}const t=o.state.vouchers.cachedProviders,r={};if(o.state.zones.allConfigured.length>0&&t.length>0)for(const e of o.state.zones.allConfigured)if(e.uuid)try{const s=await o.api.callApi(`/settings/get_zone/${e.uuid}`);if(s?.zone?.authservers){const a=s.zone.authservers;let n=[];if("object"!=typeof a||null===a||Array.isArray(a))"string"==typeof a&&""!==a.trim()?n=a.split(",").map((e=>e.trim())).filter(Boolean):Array.isArray(a)&&(n=a.map((e=>String(e).trim())).filter(Boolean));else{const e=o.utils.formatOpnsenseSelectable(a);e&&(n=e.split(",").map((e=>e.trim())).filter(Boolean))}const c=e.description||`Zone ${e.zoneid}`;n.forEach((e=>{t.includes(e)&&(r[e]||(r[e]=new Set),r[e].add(c))}))}}catch(t){console.warn(`Could not fetch details for zone ${e.uuid} for linkage card:`,t)}const s=Object.keys(r).filter((e=>r[e].size>0));if(0===s.length)e.innerHTML='<p class="text-muted-foreground">No voucher providers are currently linked to any active zones.</p>';else{let t='<ul class="space-y-3">';s.forEach((e=>{const o=Array.from(r[e]).map((e=>`<li><i class="fas fa-layer-group text-xs mr-1 text-muted"></i>${e}</li>`)).join("");t+=`<li class="border-b border-border border-dashed pb-2 last:border-b-0 last:pb-0"><span class="font-semibold text-foreground">${e}</span> is linked to:<ul class="list-none pl-4 mt-1 text-xs space-y-1">${o}</ul></li>`})),t+="</ul>",e.innerHTML=t}}catch(t){console.error("Error displaying provider-zone linkage:",t),e.innerHTML='<p class="text-danger">Could not load linkage information. Check console.</p>'}}else console.warn("Provider zone linkage details container not found.")},initializeProviderZoneLinkageCard:function(){const e=o.elements.providerZoneLinkageCard;if(!e||"true"===e.dataset.listenerAttached)return;const t=e.querySelector(".voucher-summary"),r=o.elements.providerZoneLinkageDetails;t&&r&&(t.addEventListener("click",(()=>{o.ui.toggleCardDetails(e),r.classList.contains("expanded")&&r.innerHTML.includes("Loading")&&this.displayProviderZoneLinkage()})),t.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.click())})),e.dataset.listenerAttached="true")},loadVoucherProviders:async function(e=!1){if(!o.elements.voucherProviderSelect)return;o.state.vouchers.currentPage=1,this.initializeProviderZoneLinkageCard();const t=o.elements.providerZoneLinkageDetails;if(t&&t.classList.contains("expanded")&&e&&await this.displayProviderZoneLinkage(),!e&&o.state.vouchers.cachedProviders.length>0&&Date.now()-o.state.vouchers.lastFetchedProviders<60*o.config.inMemoryCacheTTLMinutes*1e3)return this.populateVoucherProviderSelect(o.state.vouchers.cachedProviders),void(o.elements.voucherProviderSelect.value&&this.handleProviderSelection(o.elements.voucherProviderSelect.value));o.elements.voucherProviderSelect.innerHTML='<option value="">Loading providers...</option>',o.elements.voucherGroupSelect&&(o.elements.voucherGroupSelect.innerHTML='<option value="">Select provider...</option>'),o.elements.voucherCardContainer&&o.ui.clearContainer(o.elements.voucherCardContainer,"voucher-pagination"),o.elements.voucherSearchInput&&(o.elements.voucherSearchInput.value=""),o.elements.voucherStateFilterSelect&&(o.elements.voucherStateFilterSelect.value=""),o.ui.disableVoucherActionButtons(!0,!0,!0),this.updateVoidSelectedButton();try{const e=await o.api.callApi("/voucher/list_providers");Array.isArray(e)?(o.state.vouchers.cachedProviders=e,o.state.vouchers.lastFetchedProviders=Date.now(),this.populateVoucherProviderSelect(e),t&&t.classList.contains("expanded")&&await this.displayProviderZoneLinkage()):(o.state.vouchers.cachedProviders=[],o.ui.showToast("Could not load voucher providers: unexpected format.","error"),console.error("Voucher providers API returned unexpected format:",e))}catch(e){o.state.vouchers.cachedProviders=[],o.elements.voucherProviderSelect.innerHTML='<option value="">Error loading providers.</option>',o.ui.showToast("Error loading voucher providers: "+e.message,"error"),console.error("Error fetching voucher providers:",e)}},populateVoucherProviderSelect:function(e){if(!o.elements.voucherProviderSelect)return;if(0===e.length)return o.elements.voucherProviderSelect.innerHTML='<option value="">No providers found.</option>',o.ui.showToast("No voucher providers configured on OPNsense.","warning"),o.ui.disableVoucherActionButtons(!0,!0,!0),void this.updateVoidSelectedButton();o.elements.voucherProviderSelect.innerHTML='<option value="">-- Select Provider --</option>';const t=localStorage.getItem(o.config.localStorageKeys.selectedVoucherProvider);let r=null;e.forEach((e=>{const s=document.createElement("option");s.value=e,s.textContent=e,o.elements.voucherProviderSelect.appendChild(s),e===t&&(r=t)})),1!==e.length||r?r?(o.elements.voucherProviderSelect.value=r,this.handleProviderSelection(r)):(o.ui.disableVoucherActionButtons(!0,!0,!0),this.updateVoidSelectedButton()):(o.elements.voucherProviderSelect.value=e[0],localStorage.setItem(o.config.localStorageKeys.selectedVoucherProvider,e[0]),this.handleProviderSelection(e[0]))},handleProviderSelection:function(e,t=!1){o.state.vouchers.currentPage=1,this.selectedVouchers.clear(),this.updateSelectAllUI([]),o.elements.voucherSearchInput&&(o.elements.voucherSearchInput.value=""),o.elements.voucherStateFilterSelect&&(o.elements.voucherStateFilterSelect.value=""),e?(localStorage.setItem(o.config.localStorageKeys.selectedVoucherProvider,e),this.loadVoucherGroups(e,t)):(localStorage.removeItem(o.config.localStorageKeys.selectedVoucherProvider),o.elements.voucherGroupSelect&&(o.elements.voucherGroupSelect.innerHTML='<option value="">Select provider...</option>'),o.elements.voucherCardContainer&&o.ui.clearContainer(o.elements.voucherCardContainer,"voucher-pagination"),o.ui.disableVoucherActionButtons(!0,!0,!0),this.updateVoidSelectedButton())},loadVoucherGroups:async function(e,t=!1){if(o.state.vouchers.currentPage=1,this.selectedVouchers.clear(),this.updateSelectAllUI([]),o.elements.voucherSearchInput&&(o.elements.voucherSearchInput.value=""),o.elements.voucherStateFilterSelect&&(o.elements.voucherStateFilterSelect.value=""),!e||!o.elements.voucherGroupSelect)return o.elements.voucherGroupSelect&&(o.elements.voucherGroupSelect.innerHTML='<option value="">Select provider...</option>'),o.elements.voucherCardContainer&&o.ui.clearContainer(o.elements.voucherCardContainer,"voucher-pagination"),o.ui.disableVoucherActionButtons(!0,!0,!0),void this.updateVoidSelectedButton();const r=e;if(!t&&o.state.vouchers.cachedGroups[r]&&Date.now()-o.state.vouchers.cachedGroupsTimestamps[r]<60*o.config.inMemoryCacheTTLMinutes*1e3)this.populateVoucherGroupSelect(e,o.state.vouchers.cachedGroups[r]);else{o.elements.voucherGroupSelect.innerHTML='<option value="">Loading groups...</option>',!o.elements.voucherCardContainer||o.state.vouchers.cachedData[`${e}_${o.elements.voucherGroupSelect.value}`]&&!t||o.ui.showSkeletonLoaders(o.elements.voucherCardContainer,1,'<div class="skeleton-card"></div>',"voucher-pagination"),o.ui.disableVoucherActionButtons(!1,!0,!0),this.updateVoidSelectedButton();try{const t=await o.api.callApi(`/voucher/list_voucher_groups/${e}`);Array.isArray(t)?(o.state.vouchers.cachedGroups[r]=t,o.state.vouchers.cachedGroupsTimestamps[r]=Date.now(),this.populateVoucherGroupSelect(e,t)):(o.state.vouchers.cachedGroups[r]=[],o.elements.voucherGroupSelect&&(o.elements.voucherGroupSelect.innerHTML='<option value="">Error: No groups data.</option>'),o.elements.voucherCardContainer&&o.ui.showNoDataMessage(o.elements.voucherCardContainer,"Error loading groups.","fas fa-exclamation-triangle","voucher-pagination"),o.ui.disableVoucherActionButtons(!1,!0,!0),this.updateVoidSelectedButton(),console.error("Voucher groups API returned unexpected format:",t))}catch(e){o.state.vouchers.cachedGroups[r]=[],o.elements.voucherGroupSelect&&(o.elements.voucherGroupSelect.innerHTML='<option value="">Error loading groups.</option>'),o.elements.voucherCardContainer&&o.ui.showNoDataMessage(o.elements.voucherCardContainer,"Error loading groups.","fas fa-exclamation-triangle","voucher-pagination"),o.ui.disableVoucherActionButtons(!1,!0,!0),this.updateVoidSelectedButton(),console.error("Error fetching voucher groups:",e)}}},populateVoucherGroupSelect:async function(e,t){if(!o.elements.voucherGroupSelect)return;o.state.vouchers.currentPage=1;const r=`${o.config.localStorageKeys.voucherGroupFilterPrefix}${e}`,s=localStorage.getItem(r)||"";o.elements.voucherGroupSelect.innerHTML='<option value="">-- Select a Group --</option>',t.length>0?(t.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.elements.voucherGroupSelect.appendChild(t)})),s&&t.includes(s)?o.elements.voucherGroupSelect.value=s:s&&!t.includes(s)&&(o.elements.voucherGroupSelect.value="",localStorage.removeItem(r))):o.elements.voucherGroupSelect.value="",o.elements.voucherGroupSelect.value?(o.ui.disableVoucherActionButtons(!1,!1,!1),await this.loadVouchersForGroup(e,o.elements.voucherGroupSelect.value)):(o.elements.voucherCardContainer&&(0===t.length&&e?o.ui.showNoDataMessage(o.elements.voucherCardContainer,`No voucher groups for provider: <strong>${e}</strong>.`,"fas fa-folder-open","voucher-pagination"):o.ui.showNoDataMessage(o.elements.voucherCardContainer,"Select a group to see its vouchers.","fas fa-ticket-alt","voucher-pagination")),this.renderVouchers([],""),o.ui.disableVoucherActionButtons(!1,!0,!0),this.updateVoidSelectedButton())},loadVouchersForGroup:async function(e,t,r=!1){if(o.state.vouchers.currentPage=1,this.selectedVouchers.clear(),!e||!t||!o.elements.voucherCardContainer)return o.elements.voucherCardContainer&&o.ui.showNoDataMessage(o.elements.voucherCardContainer,"Provider or group not selected.","fas fa-info-circle","voucher-pagination"),o.state.vouchers.current=[],void this.renderVouchers([],t);const s=`${e}_${t}`,a=!r&&o.state.vouchers.cachedData[s]&&Date.now()-o.state.vouchers.cachedData[s].lastFetched<60*o.config.inMemoryCacheTTLMinutes*1e3;a||o.ui.showSkeletonLoaders(o.elements.voucherCardContainer,o.config.itemsPerPage,'<div class="skeleton-card"></div>',"voucher-pagination");try{if(a)o.state.vouchers.current=o.state.vouchers.cachedData[s].data;else{const r=await o.api.callApi(`/voucher/list_vouchers/${e}/${t}`),a=Array.isArray(r)?r:[];o.state.vouchers.cachedData[s]={data:a,lastFetched:Date.now()},o.state.vouchers.current=a}}catch(e){o.ui.showToast("Error loading vouchers for group: "+e.message,"error"),o.state.vouchers.current=[],o.state.vouchers.cachedData[s]&&(o.state.vouchers.cachedData[s].lastFetched=0),console.error("Error fetching vouchers for group:",e)}finally{this.applyVoucherFiltersAndRender(t)}},applyVoucherFiltersAndRender:function(e){if(!o.elements.voucherCardContainer)return;o.state.vouchers.currentPage=1;const t=o.elements.voucherSearchInput?o.elements.voucherSearchInput.value.toLowerCase():"",r=o.elements.voucherStateFilterSelect?o.elements.voucherStateFilterSelect.value:"";let s=o.state.vouchers.current;t&&(s=s.filter((e=>e.username&&e.username.toLowerCase().includes(t)))),r&&(s=s.filter((e=>e.state===r))),this.currentlyVisibleVouchers=s,this.renderVouchers(s,e)},renderVouchers:function(e,t){const r=o.elements.voucherCardContainer,s=o.elements.voucherSelectAllContainer;if(r&&s){if(o.ui.clearContainer(r,"voucher-pagination"),this.updateSelectAllUI(e),e.length>0?s.classList.remove("hidden"):s.classList.add("hidden"),!e||0===e.length){const e=o.elements.voucherSearchInput?.value,s=o.elements.voucherStateFilterSelect?.value;let a=t?`No vouchers found in group "<strong>${t}</strong>"`:"Select a group to see vouchers.";return t&&(e||s)?a+=" matching your filters.":t&&(a+="."),void o.ui.showNoDataMessage(r,a,"fas fa-folder-open","voucher-pagination")}e.slice((o.state.vouchers.currentPage-1)*o.config.itemsPerPage,o.state.vouchers.currentPage*o.config.itemsPerPage).forEach((e=>{const t=document.createElement("div");t.className="voucher-card cp-card";const s="valid"===e.state?"bg-success":"unused"===e.state?"bg-primary":"bg-danger",a=o.config.voucherStateMapping[e.state]||e.state,n=this.selectedVouchers.has(e.username),c="expired"===e.state,i=`<div class="flex-shrink-0"><input type="checkbox" class="voucher-select-checkbox form-checkbox" data-voucher-username="${e.username}" ${n?"checked":""} ${c?"disabled":""}></div>`,u=`voucher-summary-${e.username}`,l=`voucher-details-${e.username}`;t.innerHTML=`<div class="flex justify-between items-center mb-1">${i}<div class="flex items-center"><span class="info-tag ${s}" title="State: ${a}">${a}</span></div></div><div id="${u}" class="voucher-summary cursor-pointer pb-1" role="button" tabindex="0" aria-expanded="false"><div class="card-detail-row"><span class="card-label">Voucher Code</span><span class="card-value">${e.username}</span></div></div><div class="card-details-content max-h-0 overflow-hidden transition-all duration-300 ease-out text-sm space-y-1" id="${l}" aria-hidden="true"><div class="card-detail-row"><span class="card-label">Validity</span> <span class="card-value-secondary">${o.utils.formatDuration(e.validity,"seconds")}</span></div><div class="card-detail-row"><span class="card-label">Start Time</span> <span class="card-value-secondary">${o.utils.formatVoucherTimestamp(e.starttime)}</span></div><div class="card-detail-row"><span class="card-label">End Time</span> <span class="card-value-secondary">${o.utils.formatVoucherTimestamp(e.endtime)}</span></div><div class="card-detail-row"><span class="card-label">Expires At</span><span class="card-value-secondary">${e.expirytime&&0!==e.expirytime?o.utils.formatVoucherTimestamp(e.expirytime):"Never"}</span></div></div>`,r.appendChild(t)})),o.ui.renderPaginationControls(o.elements.voucherPaginationContainer,o.state.vouchers.currentPage,e.length,o.config.itemsPerPage,(r=>{o.state.vouchers.currentPage=r,this.renderVouchers(e,t)}))}},updateVoidSelectedButton:function(){const e=o.elements.voidSelectedVouchersBtn;if(!e)return;const t=this.selectedVouchers.size,r=o.elements.voucherProviderSelect&&o.elements.voucherProviderSelect.value,s=o.elements.voucherGroupSelect&&o.elements.voucherGroupSelect.value;e.innerHTML='<i class="fas fa-times-circle mr-2"></i>Void Selected',e.disabled=0===t||!r||!s},updateSelectAllUI:function(e=this.currentlyVisibleVouchers){const{voucherSelectAllContainer:t,voucherSelectAllCheckbox:r,voucherSelectedCountText:s}=o.elements;if(!t||!r||!s)return;this.updateVoidSelectedButton();const a=this.selectedVouchers.size;s.textContent=`(${a} voucher${1===a?"":"s"} selected)`;const n=e.filter((e=>"expired"!==e.state)),c=n.length>0&&n.every((e=>this.selectedVouchers.has(e.username)));r.checked=c,r.indeterminate=a>0&&!c,r.disabled=0===n.length},handleSelectAll:function(e){this.currentlyVisibleVouchers.filter((e=>"expired"!==e.state)).forEach((t=>{e?this.selectedVouchers.add(t.username):this.selectedVouchers.delete(t.username)})),this.renderVouchers(this.currentlyVisibleVouchers,o.elements.voucherGroupSelect.value)},handleVoidSelectedVouchers:async function(){const e=Array.from(this.selectedVouchers);if(0===e.length)return;const t=o.elements.voucherProviderSelect.value,r=o.elements.voucherGroupSelect.value;if(!t||!r)return void o.ui.showToast("Cannot void: Provider or Group not selected.","error");const s=`Are you sure you want to void the <strong>${e.length}</strong> selected voucher(s) from group "<strong>${r}</strong>"? This will mark them as expired.`;o.ui.showConfirmationModal("Confirm Void Selected",s,(async()=>{o.ui.showToast(`Voiding ${e.length} voucher(s)...`,"info",5e3);let s=0,a=0;const n=e.map((e=>o.api.callApi(`/voucher/expire_voucher/${t}`,"POST",{username:e}).then((e=>e&&"error"!==e.status?s++:a++)).catch((t=>{console.error(`Failed to void voucher ${e}:`,t),a++}))));await Promise.all(n);let c=s>0&&0===a?`Successfully voided all ${s} selected voucher(s).`:s>0&&a>0?`Voided ${s} voucher(s). Failed for ${a}.`:`Failed to void any of the ${a} selected voucher(s).`;o.ui.showToast(c,a>0?s>0?"warning":"error":"success"),this.selectedVouchers.clear(),this.updateVoidSelectedButton(),o.state.vouchers.currentPage=1,await this.loadVouchersForGroup(t,r,!0)}))},openGenerateVoucherModal:function(){if(!o.elements.generateVoucherModal||!o.elements.voucherProviderSelect)return;if(!o.elements.voucherProviderSelect.value)return void o.ui.showToast("Please select a voucher provider before generating vouchers.","error");o.elements.voucherGroupNameInput&&(o.elements.voucherGroupNameInput.value=""),o.elements.voucherCountSelect&&(o.elements.voucherCountSelect.value="10"),o.elements.voucherCountCustom&&(o.elements.voucherCountCustom.classList.add("hidden"),o.elements.voucherCountCustom.value="1"),o.elements.voucherLifetimeSelect&&(o.elements.voucherLifetimeSelect.value="240"),o.elements.voucherLifetimeCustom&&(o.elements.voucherLifetimeCustom.classList.add("hidden"),o.elements.voucherLifetimeCustom.value=""),o.elements.voucherUsageSelect&&(o.elements.voucherUsageSelect.value="0"),o.elements.voucherUsageCustom&&(o.elements.voucherUsageCustom.classList.add("hidden"),o.elements.voucherUsageCustom.value="");const e=document.querySelector('input[name="voucher-output-format"][value="card"]');e&&(e.checked=!0),o.elements.generateVoucherModal.classList.remove("hidden"),o.elements.generateVoucherModal.classList.add("flex"),o.elements.voucherCountSelect&&o.elements.voucherCountSelect.focus()},handleSubmitGenerateVoucher:async function(){if(!o.elements.voucherProviderSelect||!o.elements.submitGenerateVoucherBtn)return;const e=o.elements.voucherProviderSelect.value;if(!e)return void o.ui.showToast("Voucher provider not selected. Cannot generate vouchers.","error");let t,s,a="custom"===o.elements.voucherCountSelect.value?parseInt(o.elements.voucherCountCustom.value):parseInt(o.elements.voucherCountSelect.value);if(isNaN(a)||a<1)return void o.ui.showToast("Number of vouchers must be at least 1.","error");if("custom"===o.elements.voucherLifetimeSelect.value){const e=parseInt(o.elements.voucherLifetimeCustom.value);if(isNaN(e)||e<1)return void o.ui.showToast("Custom Validity (minutes) must be at least 1.","error");t=60*e}else t=60*parseInt(o.elements.voucherLifetimeSelect.value);if("custom"===o.elements.voucherUsageSelect.value){const e=parseInt(o.elements.voucherUsageCustom.value);if(isNaN(e)||e<0)return void o.ui.showToast("Custom Expires In (hours) must be non-negative.","error");s=3600*e}else{const e=parseInt(o.elements.voucherUsageSelect.value);if(isNaN(e))return void o.ui.showToast("Invalid Expires In selection.","error");s=3600*e}const n=new Date,c=`g${n.getFullYear()}${String(n.getMonth()+1).padStart(2,"0")}${String(n.getDate()).padStart(2,"0")}${String(n.getHours()).padStart(2,"0")}${String(n.getMinutes()).padStart(2,"0")}`,i=o.elements.voucherGroupNameInput.value.trim()||c,u={count:String(a),validity:String(t),expirytime:String(s),vouchergroup:i};o.elements.submitGenerateVoucherBtn.disabled=!0,o.elements.submitGenerateVoucherBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';try{const{jsPDF:t}=await Promise.all([r.e(384),r.e(264)]).then(r.bind(r,3596)),{autoTable:s}=await r.e(384).then(r.bind(r,5708)),a=await o.api.callApi(`/voucher/generate_vouchers/${e}`,"POST",u);if(a&&Array.isArray(a)&&a.length>0&&a[0].username){o.state.vouchers.lastGenerated=a;const r=document.querySelector('input[name="voucher-output-format"]:checked').value,n=new t({orientation:"portrait",unit:"mm",format:"a4"});"card"===r?this.generateVouchersAsCardPDF(o.state.vouchers.lastGenerated,i,n):"table"===r?this.generateVouchersAsTablePDF(o.state.vouchers.lastGenerated,i,n,s):"both"===r&&(this.generateVouchersAsCardPDF(o.state.vouchers.lastGenerated,i,n),n.addPage(),this.generateVouchersAsTablePDF(o.state.vouchers.lastGenerated,i,n,s));const c=(new Date).toISOString().slice(0,10).replace(/-/g,"");n.save(`${i}_${c}_vouchers.pdf`),o.ui.showToast("Vouchers PDF generated!","success"),o.ui.hideModal(o.elements.generateVoucherModal),o.state.vouchers.currentPage=1,await this.loadVoucherGroups(e,!0),o.elements.voucherGroupSelect&&(o.elements.voucherGroupSelect.value=i),await this.loadVouchersForGroup(e,i,!0)}else o.ui.showToast(`Failed to generate vouchers: ${a?.message||("error"===a?.status?"API error.":"Unknown error.")}`,"error"),console.error("Voucher generation API returned unexpected result:",a),o.state.vouchers.lastGenerated=[]}catch(e){o.state.vouchers.lastGenerated=[],o.ui.showToast("Error during voucher generation or PDF creation: "+e.message,"error"),console.error("Error generating vouchers:",e)}finally{o.elements.submitGenerateVoucherBtn.disabled=!1,o.elements.submitGenerateVoucherBtn.innerHTML="Generate"}},generateVouchersAsCardPDF:function(e,t,r){const s=r.internal.pageSize.height,a=r.internal.pageSize.width,n=(a-20-8)/3,c=(s-20-15-20)/6;let i=10;r.setFontSize(20),r.setFont("helvetica","bold"),r.text(`Vouchers for Group: ${t} (Card Style)`,a/2,i+5,{align:"center"}),i+=15,e.forEach(((e,s)=>{const u=s%18;s>0&&0===u&&(r.addPage(),i=10,r.setFontSize(20),r.setFont("helvetica","bold"),r.text(`Vouchers for Group: ${t} (Card Style - Cont.)`,a/2,i+5,{align:"center"}),i+=15);const l=u%3,h=Math.floor(u/3),d=10+l*(n+4),v=i+h*(c+4);r.setDrawColor(200),r.roundedRect(d,v,n,c,2,2,"S"),r.setFontSize(8),r.setFont("helvetica","bold"),r.setTextColor(55,65,81),r.text("Voucher Code",d+n/2,v+6,{align:"center"}),r.setFontSize(16),r.setTextColor(29,78,216),r.text(e.username||o.config.placeholderValue,d+n/2,v+16,{align:"center"});let p=v+22;e.password&&(r.setFontSize(7),r.setTextColor(75,85,99),r.text(`Password: ${e.password}`,d+n/2,p,{align:"center"}),p+=4),r.setFontSize(6),r.setTextColor(107,114,128),r.text(`Validity: ${o.utils.formatDuration(e.validity,"seconds")}`,d+n/2,p+3,{align:"center"}),r.text(`Expires: ${e.expirytime&&0!==e.expirytime?o.utils.formatVoucherTimestamp(e.expirytime):"Never"}`,d+n/2,p+6,{align:"center"}),r.text(`Group: ${e.vouchergroup||o.config.placeholderValue}`,d+n/2,p+9,{align:"center"})}))},generateVouchersAsTablePDF:function(e,t,r,s){r.setFontSize(18),r.setFont("helvetica","bold"),r.text(`Voucher Table for Group: ${t}`,r.internal.pageSize.width/2,20,{align:"center"});const a=e.map((e=>[e.username||o.config.placeholderValue,e.password||o.config.placeholderValue,o.utils.formatDuration(e.validity,"seconds"),e.expirytime&&0!==e.expirytime?o.utils.formatVoucherTimestamp(e.expirytime):"Never",e.vouchergroup||o.config.placeholderValue]));s(r,{startY:30,head:[["Voucher Code","Password","Validity","Expires","Group"]],body:a,theme:"striped",headStyles:{fillColor:[41,128,185],textColor:[255,255,255]},styles:{fontSize:8,cellPadding:2,valign:"middle",halign:"center"},columnStyles:{0:{cellWidth:30},1:{cellWidth:25},2:{cellWidth:25},3:{cellWidth:40},4:{cellWidth:"auto"}},didDrawPage:function(e){let t="Page "+r.internal.getNumberOfPages();r.setFontSize(8),r.text(t,r.internal.pageSize.width-e.settings.margin.right,r.internal.pageSize.height-5)}})},handleDropExpiredVouchers:async function(){if(!o.elements.voucherProviderSelect||!o.elements.voucherGroupSelect)return;const e=o.elements.voucherProviderSelect.value,t=o.elements.voucherGroupSelect.value;e?t?o.ui.showConfirmationModal("Drop Expired Vouchers?",`Remove all expired vouchers from group "<strong>${t}</strong>" for provider "<strong>${e}</strong>"?`,(async()=>{try{const r=await o.api.callApi(`/voucher/drop_expired_vouchers/${e}/${t}`,"POST",{});r&&"drop"===r.status?o.ui.showToast(`Expired vouchers from group "${t}" (Provider: ${e}) cleaned. Count: ${r.count||0}`,"success"):(o.ui.showToast(`Cleanup for group "${t}" (Provider: ${e}) processed. Status: ${r.status||"unknown"}. Count: ${r.count||0}`,"info"),console.warn("Drop expired vouchers API returned unexpected status:",r)),o.state.vouchers.currentPage=1,await this.loadVouchersForGroup(e,t,!0)}catch(e){o.ui.showToast("Error dropping expired vouchers: "+e.message,"error"),console.error("Error dropping expired vouchers:",e)}})):o.ui.showToast("Select voucher group.","error"):o.ui.showToast("Select voucher provider.","error")},handleDropVoucherGroup:async function(){if(!o.elements.voucherProviderSelect||!o.elements.voucherGroupSelect)return;const e=o.elements.voucherProviderSelect.value,t=o.elements.voucherGroupSelect.value;e?t?o.ui.showConfirmationModal("Drop Voucher Group?",`Delete entire voucher group "<strong>${t}</strong>" for provider "<strong>${e}</strong>"? This deletes all vouchers within.`,(async()=>{try{const r=await o.api.callApi(`/voucher/drop_voucher_group/${e}/${t}`,"POST",{});r&&"error"!==r.status?(o.ui.showToast(`Voucher group "${t}" (Provider: ${e}) deleted.`,"success"),o.state.vouchers.cachedGroups[e]&&(o.state.vouchers.cachedGroups[e]=o.state.vouchers.cachedGroups[e].filter((e=>e!==t))),delete o.state.vouchers.cachedData[`${e}_${t}`],o.state.vouchers.currentPage=1,await this.loadVoucherGroups(e,!0),o.elements.voucherGroupSelect&&!o.elements.voucherGroupSelect.value&&(o.elements.voucherCardContainer&&o.ui.showNoDataMessage(o.elements.voucherCardContainer,"Select a group to see its vouchers.","fas fa-ticket-alt","voucher-pagination"),o.state.vouchers.current=[]),o.ui.disableVoucherActionButtons(!1,!0,!0)):(o.ui.showToast(`Failed to delete voucher group "${t}". API: ${r?r.message:"Unknown error."}`,"error"),console.error("Drop voucher group API returned error or unexpected result:",r))}catch(e){o.ui.showToast("Error dropping voucher group: "+e.message,"error"),console.error("Error dropping voucher group:",e)}})):o.ui.showToast("Select voucher group to delete.","warning"):o.ui.showToast("Select voucher provider.","warning")},initializeVoucherEventListeners:function(){o.elements.voucherProviderSelect&&o.elements.voucherProviderSelect.addEventListener("change",(e=>this.handleProviderSelection(e.target.value))),o.elements.voucherGroupSelect&&o.elements.voucherGroupSelect.addEventListener("change",(async e=>{const t=o.elements.voucherProviderSelect?.value,r=e.target.value;if(this.selectedVouchers.clear(),this.updateSelectAllUI([]),o.elements.voucherSearchInput&&(o.elements.voucherSearchInput.value=""),o.elements.voucherStateFilterSelect&&(o.elements.voucherStateFilterSelect.value=""),!t)return o.ui.showToast("Select a voucher provider.","warning"),void(e.target.value="");const s=`${o.config.localStorageKeys.voucherGroupFilterPrefix}${t}`;localStorage.setItem(s,r),o.state.vouchers.currentPage=1,r?(await this.loadVouchersForGroup(t,r),o.ui.disableVoucherActionButtons(!1,!1,!1)):(o.elements.voucherCardContainer&&o.ui.showNoDataMessage(o.elements.voucherCardContainer,"Select a group to see its vouchers.","fas fa-ticket-alt","voucher-pagination"),o.state.vouchers.current=[],this.renderVouchers([],""),o.ui.disableVoucherActionButtons(!1,!0,!0))}));const e=()=>{const e=o.elements.voucherGroupSelect?.value;e&&this.applyVoucherFiltersAndRender(e)};o.elements.voucherSearchInput&&o.elements.voucherSearchInput.addEventListener("input",e),o.elements.voucherStateFilterSelect&&o.elements.voucherStateFilterSelect.addEventListener("change",e),o.elements.voidSelectedVouchersBtn&&o.elements.voidSelectedVouchersBtn.addEventListener("click",(()=>this.handleVoidSelectedVouchers())),o.elements.voucherSelectAllCheckbox&&o.elements.voucherSelectAllCheckbox.addEventListener("change",(e=>this.handleSelectAll(e.target.checked))),o.elements.voucherCardContainer&&o.elements.voucherCardContainer.addEventListener("click",(e=>{const t=e.target.closest(".voucher-select-checkbox");if(t)return t.checked?this.selectedVouchers.add(t.dataset.voucherUsername):this.selectedVouchers.delete(t.dataset.voucherUsername),void this.updateSelectAllUI();const r=e.target.closest(".voucher-card");r&&o.ui.toggleCardDetails(r)})),o.elements.createVouchersBtn&&o.elements.createVouchersBtn.addEventListener("click",(()=>this.openGenerateVoucherModal())),o.elements.dropExpiredVouchersBtn&&o.elements.dropExpiredVouchersBtn.addEventListener("click",(()=>this.handleDropExpiredVouchers())),o.elements.dropVoucherGroupBtn&&o.elements.dropVoucherGroupBtn.addEventListener("click",(()=>this.handleDropVoucherGroup())),o.elements.submitGenerateVoucherBtn&&o.elements.submitGenerateVoucherBtn.addEventListener("click",(()=>this.handleSubmitGenerateVoucher())),o.elements.cancelGenerateVoucherBtn&&o.elements.cancelGenerateVoucherBtn.addEventListener("click",(()=>o.ui.hideModal(o.elements.generateVoucherModal))),o.elements.voucherCountSelect&&o.elements.voucherCountCustom&&o.elements.voucherCountSelect.addEventListener("change",(e=>{o.elements.voucherCountCustom.classList.toggle("hidden","custom"!==e.target.value)})),o.elements.voucherLifetimeSelect&&o.elements.voucherLifetimeCustom&&o.elements.voucherLifetimeSelect.addEventListener("change",(e=>{o.elements.voucherLifetimeCustom.classList.toggle("hidden","custom"!==e.target.value)})),o.elements.voucherUsageSelect&&o.elements.voucherUsageCustom&&o.elements.voucherUsageSelect.addEventListener("change",(e=>{o.elements.voucherUsageCustom.classList.toggle("hidden","custom"!==e.target.value)}))}},o.state.vouchers.selectedVouchers||(o.state.vouchers.selectedVouchers=new Set)}}]);
//# sourceMappingURL=469.5e5c950da53ca00f61dc.js.map