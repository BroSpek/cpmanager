(()=>{var e,t,n,s,o,a={136:()=>{window.CPManager=window.CPManager||{},CPManager.config={baseUrl:null,placeholderValue:"â€”",inMemoryCacheTTLMinutes:1,itemsPerPage:6,predefinedColors:["bg-pink-500","bg-purple-500","bg-indigo-500","bg-teal-500","bg-lime-500","bg-amber-500","bg-orange-500","bg-cyan-500","bg-red-600","bg-green-600","bg-blue-600","bg-yellow-600"],authViaMapping:{"---ip---":"IP","---mac---":"MAC","Local Database":"Local DB",Voucher:"Voucher","":"Anon"},voucherStateMapping:{unused:"Unused",valid:"Active",expired:"Expired"},zoneFieldMappings:{enabled:"Enabled",zoneid:"Zone ID",interfaces:"Interfaces",disableRules:"Disable Auto Rules",authservers:"Auth Servers",alwaysSendAccountingReqs:"RADIUS Accounting",authEnforceGroup:"Enforce Group",idletimeout:"Idle Timeout",hardtimeout:"Hard Timeout",concurrentlogins:"Concurrent Logins",certificate:"SSL Certificate",servername:"HTTPS Server Name",allowedAddresses:"Allowed IPs",allowedMACAddresses:"Allowed MACs",extendedPreAuthData:"Extended Pre-Auth Data",template:"Login Page Template",description:"Description",uuid:"UUID"},localStorageKeys:{theme:"theme",activeTab:"activeHelpdeskTab",apiKey:"opnsenseApiKey",apiSecret:"opnsenseApiSecret",apiBaseUrl:"opnsenseApiBaseUrl",sessionZoneFilter:"sessionZoneFilter",selectedVoucherProvider:"selectedVoucherProvider",voucherGroupFilterPrefix:"voucherGroupFilter_",signInNotificationsEnabled:"signInNotificationsEnabled"}},CPManager.state={currentApiKey:"",currentApiSecret:"",confirmCallback:null,zoneColors:{},authViaColors:{},zoneColorIndex:0,authViaColorIndex:Math.floor(CPManager.config.predefinedColors.length/2),sessions:{all:[],lastFetched:0,managerDetails:null,currentPage:1},vouchers:{current:[],lastGenerated:[],cachedProviders:[],lastFetchedProviders:0,cachedGroups:{},cachedGroupsTimestamps:{},cachedData:{},currentPage:1},zones:{allConfigured:[],lastFetched:0,originalFullDataForEdit:null,customTemplates:[],customTemplatesLastFetched:0,currentPage:1},dashboard:{chartInstance:null,originalUploadBytes:0,originalDownloadBytes:0,originalTotalBytes:0,apiDataCache:{sessions:null,sessionsLastFetched:0,voucherStats:null,voucherStatsLastFetched:0}},notifications:{previousSessionIds:new Set,isFirstPoll:!0,sessionPollIntervalId:null,POLLING_INTERVAL:3e4,POLLING_INTERVAL_HIDDEN_TAB:3e5,consecutivePollErrors:0,MAX_POLL_ERRORS_BEFORE_DISABLE:5}}},1549:()=>{!function(e){e.utils={getZoneColor:function(t){return e.state.zoneColors[t]||(e.state.zoneColors[t]=e.config.predefinedColors[e.state.zoneColorIndex%e.config.predefinedColors.length],e.state.zoneColorIndex=(e.state.zoneColorIndex+1)%e.config.predefinedColors.length),e.state.zoneColors[t]},getAuthViaColor:function(t){return e.state.authViaColors[t]||(e.state.authViaColors[t]=e.config.predefinedColors[e.state.authViaColorIndex%e.config.predefinedColors.length],e.state.authViaColorIndex=(e.state.authViaColorIndex+1)%e.config.predefinedColors.length,e.state.authViaColorIndex===e.state.zoneColorIndex&&(e.state.authViaColorIndex=(e.state.authViaColorIndex+1)%e.config.predefinedColors.length)),e.state.authViaColors[t]},formatBytes:function(e,t=2){if(0===e||!e||isNaN(e))return"0 Bytes";const n=t<0?0:t,s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(n))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][s]},formatAuthVia:function(t){return e.config.authViaMapping[t]||t||e.config.placeholderValue},formatVoucherTimestamp:function(t){if(!t||0===t)return e.config.placeholderValue;try{return new Date(1e3*t).toLocaleString()}catch(e){return console.error("Error formatting timestamp:",t,e),"Invalid Date"}},formatDuration:function(t,n="minutes"){let s;if("minutes"===n){if(0===parseInt(t))return"No Timeout";s=60*parseInt(t)}else{if(0===parseInt(t)&&"seconds"===n)return"0s";s=parseInt(t)}if(isNaN(s)||null===s||s<0)return e.config.placeholderValue;const o=Math.floor(s/86400);s%=86400;const a=Math.floor(s/3600);s%=3600;const i=Math.floor(s/60),r=s%60;let l=[];return o>0&&l.push(`${o}d`),a>0&&l.push(`${a}h`),i>0&&l.push(`${i}m`),r>0&&"seconds"===n&&l.length<3&&l.push(`${r}s`),0===l.length?"seconds"===n&&t>0?`${t}s`:"minutes"===n&&t>0?`${t}m`:"minutes"===n&&0===parseInt(t)?"No Timeout":"0s":l.join(" ")},formatOpnsenseSelectable:function(e){if("object"!=typeof e||null===e)return String(e||"");const t=[];for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const s=e[n];"object"==typeof s&&null!==s&&1===s.selected&&t.push(s.value||n)}return t.length>0?t.join(", "):e.value&&1===Object.keys(e).length?String(e.value):""},getZoneDescription:function(t){const n=e.state.zones.allConfigured.find((e=>String(e.zoneid)===String(t)));return n?n.description:`Zone ${t}`},getMacAddressType:function(e){if(!e||"string"!=typeof e)return null;const t=e.match(/^([0-9A-Fa-f]{2})[:|-]([0-9A-Fa-f]{2})[:|-]([0-9A-Fa-f]{2})[:|-]([0-9A-Fa-f]{2})[:|-]([0-9A-Fa-f]{2})[:|-]([0-9A-Fa-f]{2})$/);if(!t){if(/^[0-9A-Fa-f]{12}$/.test(e)){const t=e.substring(0,2),n=parseInt(t,16);return isNaN(n)?null:2&n?"private":"device"}return null}const n=t[1],s=parseInt(n,16);return isNaN(s)?null:2&s?"private":"device"}}}(window.CPManager)},3159:()=>{var e;(e=CPManager).sessions={selectedSessions:new Set,currentlyVisibleSessions:[],fetchManagerSessionStatus:async function(){try{const t=await fetch(`${e.config.baseUrl}/api/captiveportal/access/status/0`),n=await t.text();if(!t.ok)return console.warn(`Manager session status check failed: ${t.status} ${t.statusText}`),void(e.state.sessions.managerDetails=null);const s=JSON.parse(n);s&&s.sessionId&&"AUTHORIZED"===s.clientState?(e.state.sessions.managerDetails={sessionId:s.sessionId,zoneid:String(s.zoneid),ipAddress:s.ipAddress},console.log("Current device's session identified:",e.state.sessions.managerDetails.ipAddress,"ID:",e.state.sessions.managerDetails.sessionId.substring(0,8)+"..."),e.elements.tabPanes.sessions&&e.elements.tabPanes.sessions.classList.contains("active")&&e.sessions.applySessionFilters()):(e.state.sessions.managerDetails=null,console.log("Current device not connected via authorized captive portal session, or status endpoint returned unexpected data."))}catch(t){console.error("Exception during fetchManagerSessionStatus:",t.message),e.state.sessions.managerDetails=null}},loadSessions:async function(t=!1){if(e.elements.sessionCardContainer){if(e.state.sessions.currentPage=1,this.selectedSessions.clear(),0===e.state.zones.allConfigured.length&&await e.zones.fetchAllZoneData(),this.populateSessionZoneFilter(),!t&&e.state.sessions.all.length>0&&Date.now()-e.state.sessions.lastFetched<60*e.config.inMemoryCacheTTLMinutes*1e3)return console.log("Using cached sessions. Applying filters."),void this.applySessionFilters();e.ui.showSkeletonLoaders(e.elements.sessionCardContainer,e.config.itemsPerPage,'<div class="skeleton-card"></div>',"session-pagination"),this.updateSelectAllUI();try{const t=await e.api.callApi("/session/search");t&&Array.isArray(t.rows)?(e.state.sessions.all=t.rows,e.state.sessions.lastFetched=Date.now(),this.applySessionFilters()):(console.error("Error loading sessions: API response `data.rows` is not an array or data is undefined.",t),e.ui.showNoDataMessage(e.elements.sessionCardContainer,"Error: Unexpected data format for sessions.","fas fa-exclamation-triangle","session-pagination"),e.state.sessions.all=[],this.currentlyVisibleSessions=[],this.updateSelectAllUI())}catch(t){console.error("Error loading sessions:",t),e.ui.showNoDataMessage(e.elements.sessionCardContainer,"Could not load sessions. Check API connection and OPNsense logs.","fas fa-exclamation-triangle","session-pagination"),e.state.sessions.all=[],this.currentlyVisibleSessions=[],this.updateSelectAllUI()}}},populateSessionZoneFilter:function(){if(!e.elements.sessionZoneFilterSelect)return;const t=localStorage.getItem(e.config.localStorageKeys.sessionZoneFilter)||"";e.elements.sessionZoneFilterSelect.innerHTML='<option value="">All Zones</option>',e.state.zones.allConfigured.length>0&&(e.state.zones.allConfigured.forEach((t=>{const n=document.createElement("option");n.value=t.zoneid,n.textContent=t.description||`Zone ${t.zoneid}`,e.elements.sessionZoneFilterSelect.appendChild(n)})),e.elements.sessionZoneFilterSelect.value=t)},applySessionFilters:function(){if(!e.elements.sessionCardContainer)return;e.state.sessions.currentPage=1,this.selectedSessions.clear();const t=e.elements.sessionSearchInput?e.elements.sessionSearchInput.value.toLowerCase():"",n=e.elements.sessionZoneFilterSelect?e.elements.sessionZoneFilterSelect.value:"";e.elements.sessionZoneFilterSelect&&localStorage.setItem(e.config.localStorageKeys.sessionZoneFilter,n);let s=e.state.sessions.all;n&&(s=s.filter((e=>String(e.zoneid)===n))),t&&(s=s.filter((e=>e.ipAddress&&e.ipAddress.toLowerCase().includes(t)||e.macAddress&&e.macAddress.toLowerCase().includes(t)||e.userName&&e.userName.toLowerCase().includes(t)||e.sessionId&&e.sessionId.toLowerCase().includes(t)))),this.currentlyVisibleSessions=s,this.renderSessions(s)},renderSessions:function(t){if(!e.elements.sessionCardContainer)return;const n=e.elements.sessionSelectAllContainer;if(e.ui.clearContainer(e.elements.sessionCardContainer,"session-pagination"),this.updateSelectAllUI(),!t||!Array.isArray(t)||0===t.length)return n&&n.classList.add("hidden"),void e.ui.showNoDataMessage(e.elements.sessionCardContainer,"No sessions match filters or no active sessions found.","fas fa-users-slash","session-pagination");n&&n.classList.remove("hidden");const s=e.state.sessions.currentPage,o=e.config.itemsPerPage,a=(s-1)*o,i=a+o;t.slice(a,i).forEach((t=>{const n=e.utils.getZoneDescription(t.zoneid),s=e.utils.getZoneColor(t.zoneid),o=e.utils.formatAuthVia(t.authenticated_via),a=e.utils.getAuthViaColor(o),i=e.utils.getMacAddressType(t.macAddress);let r="";if(i){const e="device"===i?"bg-accent":"bg-purple-500",t=i.charAt(0).toUpperCase()+i.slice(1);r=`<span class="info-tag ${e}" title="MAC Type: ${t}">${t}</span>`}const l=e.state.sessions.managerDetails&&t.sessionId===e.state.sessions.managerDetails.sessionId&&String(t.zoneid)===e.state.sessions.managerDetails.zoneid,c=this.selectedSessions.has(t.sessionId),d=document.createElement("div");d.className="session-card cp-card "+(l?"ring-2 ring-offset-1 ring-primary":""),d.setAttribute("role","listitem"),d.setAttribute("aria-label",`Session for IP ${t.ipAddress||"Unknown IP"}`);let u="";l&&(u=`<span class="info-tag bg-primary flex items-center" title="This is your current device's session (IP: ${e.state.sessions.managerDetails.ipAddress||"N/A"})"><i class="fas fa-user-shield mr-1"></i>You</span>`);const h=`\n            <div class="flex-shrink-0">\n                <input type="checkbox" class="session-select-checkbox form-checkbox" data-session-id="${t.sessionId}" ${c?"checked":""}>\n            </div>`,p=`\n            <div class="flex items-center gap-1">\n                ${u}\n                ${r}\n                <span class="info-tag ${a}" title="Authenticated Via: ${o}">${o}</span>\n                <span class="info-tag ${s}" title="Zone: ${n}">${n}</span>\n            </div>`,m=`session-summary-${t.sessionId}`,g=`session-details-${t.sessionId}`;d.innerHTML=`\n            <div class="flex justify-between items-center mb-1">\n                ${h}\n                ${p}\n            </div>\n            <div id="${m}" class="session-summary cursor-pointer pb-1" role="button" tabindex="0" aria-expanded="false" aria-controls="${g}">\n                <div class="space-y-1">\n                    <div class="card-detail-row"><span class="card-label">IP Address</span> <span class="card-value">${t.ipAddress||e.config.placeholderValue}</span></div>\n                    <div class="card-detail-row"><span class="card-label">User</span> <span class="card-value">${t.userName||e.config.placeholderValue}</span></div>\n                    <div class="card-detail-row"><span class="card-label">MAC</span> <span class="card-value">${t.macAddress||e.config.placeholderValue}</span></div>\n                </div>\n            </div>\n            <div class="card-details-content max-h-0 overflow-hidden transition-all duration-300 ease-out text-sm space-y-1" id="${g}" aria-hidden="true">\n                <div class="card-detail-row"><span class="card-label">Zone ID</span> <span class="card-value-secondary">${t.zoneid}</span></div>\n                <div class="card-detail-row"><span class="card-label">Session ID</span> <span class="card-value-secondary">${t.sessionId||e.config.placeholderValue}</span></div>\n                <div class="card-detail-row"><span class="card-label">Start Time</span> <span class="card-value-secondary">${t.startTime?new Date(1e3*t.startTime).toLocaleString():e.config.placeholderValue}</span></div>\n                <div class="card-detail-row"><span class="card-label">Last Accessed</span> <span class="card-value-secondary">${t.last_accessed?new Date(1e3*t.last_accessed).toLocaleString():e.config.placeholderValue}</span></div>\n                <div class="card-detail-row"><span class="card-label">Packets Uploaded</span> <span class="card-value-secondary">${void 0!==t.packets_in?t.packets_in.toLocaleString():e.config.placeholderValue}</span></div>\n                <div class="card-detail-row"><span class="card-label">Packets Downloaded</span> <span class="card-value-secondary">${void 0!==t.packets_out?t.packets_out.toLocaleString():e.config.placeholderValue}</span></div>\n                <div class="card-detail-row"><span class="card-label">Data Uploaded</span> <span class="card-value-secondary">${void 0!==t.bytes_in?e.utils.formatBytes(t.bytes_in):e.config.placeholderValue}</span></div>\n                <div class="card-detail-row"><span class="card-label">Data Downloaded</span> <span class="card-value-secondary">${void 0!==t.bytes_out?e.utils.formatBytes(t.bytes_out):e.config.placeholderValue}</span></div>\n                <div class="card-detail-row"><span class="card-label">Acc. Timeout</span> <span class="card-value-secondary">${t.acc_session_timeout?e.utils.formatDuration(t.acc_session_timeout,"seconds"):e.config.placeholderValue}</span></div>\n            </div>`,e.elements.sessionCardContainer.appendChild(d)})),e.ui.renderPaginationControls(e.elements.sessionPaginationContainer,e.state.sessions.currentPage,t.length,e.config.itemsPerPage,(n=>{e.state.sessions.currentPage=n,this.renderSessions(t)}))},updateDisconnectSelectedButton:function(){const t=e.elements.disconnectSelectedSessionsBtn;if(!t)return;const n=this.selectedSessions.size;t.innerHTML='<i class="fas fa-times-circle mr-2"></i>Disconnect',t.disabled=0===n},updateSelectAllUI:function(){const{sessionSelectAllCheckbox:t,sessionSelectedCountText:n,sessionSelectAllContainer:s}=e.elements;if(!t||!n||!s)return;this.updateDisconnectSelectedButton();const o=this.selectedSessions.size;n.textContent=`(${o} session${1===o?"":"s"} selected)`;const a=this.currentlyVisibleSessions;if(0===a.length)return s.classList.add("hidden"),t.checked=!1,t.indeterminate=!1,void(t.disabled=!0);s.classList.remove("hidden"),t.disabled=!1;const i=a.every((e=>this.selectedSessions.has(e.sessionId)));t.checked=i,t.indeterminate=o>0&&!i},handleSelectAll:function(e){this.currentlyVisibleSessions.forEach((t=>{e?this.selectedSessions.add(t.sessionId):this.selectedSessions.delete(t.sessionId)})),this.renderSessions(this.currentlyVisibleSessions)},handleDisconnectSelectedSessions:async function(){const t=Array.from(this.selectedSessions);if(0===t.length)return void e.ui.showToast("No sessions selected.","info");const n=e.state.sessions.all.filter((e=>t.includes(e.sessionId)));if(0===n.length)return e.ui.showToast("Could not find details for selected sessions. Please refresh.","error"),this.selectedSessions.clear(),void this.updateSelectAllUI();const s=e.state.sessions.managerDetails?.sessionId&&this.selectedSessions.has(e.state.sessions.managerDetails.sessionId);let o="Disconnect Selected Sessions?",a=`Are you sure you want to disconnect the <strong>${n.length}</strong> selected session(s)?`;s&&(o="Warning: Disconnecting Own Session",a=`<div class="alert-box alert-box-danger"><i class="fas fa-biohazard mr-2 mt-1 text-danger"></i><span><strong>DANGER:</strong> Your own session is included in the selection. Disconnecting it may lock you out of this manager.</span></div><p class="mt-4">Disconnect <strong>${n.length}</strong> session(s) anyway?</p>`),e.ui.showConfirmationModal(o,a,(async()=>{e.ui.showToast(`Disconnecting ${n.length} session(s)...`,"info",5e3);let t=0,s=0;const o=n.map((n=>e.api.callApi(`/session/disconnect/${n.zoneid}`,"POST",{sessionId:n.sessionId}).then((e=>{e&&(e.terminateCause||"ok"===e.status||"ok_text"===e.status)?t++:(s++,console.warn(`Failed to disconnect session ${n.sessionId}:`,e))})).catch((e=>{s++,console.error(`Error disconnecting session ${n.sessionId}:`,e)}))));await Promise.all(o);let a="",i="info";t>0&&0===s?(a=`Successfully disconnected all ${t} selected sessions.`,i="success"):t>0&&s>0?(a=`Disconnected ${t} sessions. Failed for ${s}. Check console.`,i="warning"):0===t&&s>0&&(a=`Failed to disconnect any of the ${s} selected sessions. Check console.`,i="error"),e.ui.showToast(a,i,7e3),this.selectedSessions.clear(),await this.loadSessions(!0)}))},initializeSessionEventListeners:function(){e.elements.sessionSearchInput&&e.elements.sessionSearchInput.addEventListener("input",(()=>this.applySessionFilters())),e.elements.sessionZoneFilterSelect&&e.elements.sessionZoneFilterSelect.addEventListener("change",(()=>this.applySessionFilters())),e.elements.sessionCardContainer&&e.elements.sessionCardContainer.addEventListener("click",(t=>{const n=t.target.closest(".session-select-checkbox");if(n){const t=n.dataset.sessionId;return n.checked?(this.selectedSessions.add(t),e.state.sessions.managerDetails&&t===e.state.sessions.managerDetails.sessionId&&e.ui.showToast("Warning: You have selected your own session.","warning",4e3)):this.selectedSessions.delete(t),void this.updateSelectAllUI()}const s=t.target.closest(".session-card");s&&e.ui.toggleCardDetails(s)})),e.elements.disconnectSelectedSessionsBtn&&e.elements.disconnectSelectedSessionsBtn.addEventListener("click",(()=>this.handleDisconnectSelectedSessions())),e.elements.sessionSelectAllCheckbox&&e.elements.sessionSelectAllCheckbox.addEventListener("change",(e=>this.handleSelectAll(e.target.checked))),e.elements.findMySessionBtn&&e.elements.findMySessionBtn.addEventListener("click",(async()=>{e.state.sessions.managerDetails&&e.state.sessions.managerDetails.sessionId?(e.ui.showToast(`Found your session (IP: ${e.state.sessions.managerDetails.ipAddress}). Highlighting...`,"info"),e.elements.sessionZoneFilterSelect&&(e.elements.sessionZoneFilterSelect.value=""),e.elements.sessionSearchInput&&(e.elements.sessionSearchInput.value=e.state.sessions.managerDetails.sessionId),this.applySessionFilters(),e.tabs.setActiveTab("sessions"),setTimeout((()=>{const e=document.querySelector(".is-manager-session");e&&e.scrollIntoView({behavior:"smooth",block:"center"})}),300)):(e.ui.showToast("Your session details not found. Fetching...","warning"),await this.fetchManagerSessionStatus(),e.state.sessions.managerDetails?e.elements.findMySessionBtn.click():e.ui.showToast("Still couldn't find your session. Ensure you are logged into the portal.","warning"))}))}}},3415:()=>{var e;(e=CPManager).zones={fetchAllZoneData:async function(t=!1){if(!(!t&&e.state.zones.allConfigured.length>0&&void 0!==e.state.zones.allConfigured[0].description&&Date.now()-e.state.zones.lastFetched<60*e.config.inMemoryCacheTTLMinutes*1e3))try{const t=await e.api.callApi("/settings/search_zones");t&&Array.isArray(t.rows)?(e.state.zones.allConfigured=t.rows,e.state.zones.lastFetched=Date.now()):(e.state.zones.allConfigured=[],console.warn("No zones found or unexpected data format from /settings/search_zones.",t))}catch(t){console.error("Failed to fetch all zone data for descriptions:",t.message),e.state.zones.allConfigured=[]}},fetchCustomTemplates:async function(t=!1){if(!(!t&&e.state.zones.customTemplates.length>0&&Date.now()-e.state.zones.customTemplatesLastFetched<60*e.config.inMemoryCacheTTLMinutes*1e3))try{const t=await e.api.callApi("/service/search_templates");t&&Array.isArray(t.rows)?(e.state.zones.customTemplates=t.rows,e.state.zones.customTemplatesLastFetched=Date.now()):(e.state.zones.customTemplates=[],console.warn("No custom templates found or unexpected data format.",t))}catch(t){console.error("Failed to fetch custom templates:",t.message),e.state.zones.customTemplates=[]}},loadZoneInfo:async function(t=!1){if(e.elements.zoneListContainer){e.state.zones.currentPage=1,(t||0===e.elements.zoneListContainer.querySelectorAll(".zone-info-card").length)&&e.ui.showSkeletonLoaders(e.elements.zoneListContainer,e.config.itemsPerPage,'<div class="skeleton-card"></div>',"zone-pagination");try{if(await e.zones.fetchAllZoneData(t),await e.zones.fetchCustomTemplates(t),e.ui.clearContainer(e.elements.zoneListContainer,"zone-pagination"),!Array.isArray(e.state.zones.allConfigured)||0===e.state.zones.allConfigured.length)return void e.ui.showNoDataMessage(e.elements.zoneListContainer,"No captive portal zones configured on OPNsense.","fas fa-folder-open","zone-pagination");const n=e.state.zones.allConfigured,s=e.state.zones.currentPage,o=e.config.itemsPerPage,a=(s-1)*o,i=a+o;n.slice(a,i).forEach((t=>{const n=document.createElement("div");n.className="zone-info-card cp-card",n.setAttribute("role","listitem"),n.setAttribute("aria-label",`Zone: ${t.description||`Zone ID ${t.zoneid}`}`);const s="1"===t.enabled?"Enabled":"Disabled",o=`<span class="info-tag ${"1"===t.enabled?"bg-success":"bg-danger"}" title="Status: ${s}">${s}</span>`,a=`zone-summary-${t.uuid}`,i=`zone-details-${t.uuid}`;n.innerHTML=`\n            <div class="flex justify-end items-center mb-1">\n                <div class="flex items-center gap-1">\n                    ${o}\n                </div>\n            </div>\n            <div id="${a}" class="zone-summary cursor-pointer pb-1" role="button" tabindex="0" aria-expanded="false" aria-controls="${i}">\n              <div class="card-detail-row"><span class="card-label">Name</span><span class="card-value">${t.description||`Unnamed Zone (ID: ${t.zoneid})`}</span></div>\n              <div class="card-detail-row"><span class="card-label">Zone ID</span><span class="card-value">${t.zoneid}</span></div>\n              <div class="card-detail-row"><span class="card-label">Short UUID</span><span class="card-value">${t.uuid.substring(0,8)}...</span></div>\n            </div>\n            <div class="card-details-content max-h-0 overflow-hidden transition-all duration-300 ease-out text-sm space-y-1" id="${i}" aria-hidden="true">Loading details...</div>`,n.dataset.uuid=t.uuid,n.dataset.initialZoneid=t.zoneid,e.elements.zoneListContainer.appendChild(n)})),e.ui.renderPaginationControls(e.elements.zonePaginationContainer,e.state.zones.currentPage,n.length,e.config.itemsPerPage,(t=>{e.state.zones.currentPage=t,e.zones.loadZoneInfo()}))}catch(t){console.error("Error in loadZoneInfo:",t),e.ui.showNoDataMessage(e.elements.zoneListContainer,"Error loading zone information.","fas fa-exclamation-triangle","zone-pagination")}}},handleZoneCardClick:async function(t,n){if(e.ui.toggleCardDetails(t),n.classList.contains("expanded")&&(n.innerHTML.includes("Loading details...")||n.innerHTML.includes("Error loading details"))){const s=t.dataset.uuid;try{const t=await e.api.callApi(`/settings/get_zone/${s}`);let o="";const a=(t,n)=>`<div class="card-detail-row"><span class="card-label">${t}</span> <span class="card-value-secondary">${null==n||""===String(n).trim()?e.config.placeholderValue:String(n)}</span></div>`;if(o+=a("UUID",s),t&&t.zone){const n=t.zone;for(const[t,s]of Object.entries(n)){if("uuid"===t||"description"===t||"enabled"===t||"zoneid"===t)continue;const n=e.config.zoneFieldMappings[t]||t.charAt(0).toUpperCase()+t.slice(1).replace(/([A-Z])/g," $1");let i;if("idletimeout"===t||"hardtimeout"===t)i=s?e.utils.formatDuration(parseInt(s),"minutes"):e.config.placeholderValue;else if("template"===t){let t="";if("object"==typeof s&&null!==s)for(const e in s)if(s[e]&&(1===s[e].selected||"1"===s[e].selected)){t=e;break}const n=e.state.zones.customTemplates.find((e=>e.uuid===t));i=n?n.name:t?`UUID: ${t.substring(0,8)}...`:"Default"}else i=["disableRules","alwaysSendAccountingReqs","concurrentlogins","extendedPreAuthData"].includes(t)?"1"===String(s)?"Yes":"0"===String(s)?"No":String(s):"object"==typeof s&&null!==s&&Object.values(s).some((e=>"object"==typeof e&&null!==e&&Object.prototype.hasOwnProperty.call(e,"selected")))?e.utils.formatOpnsenseSelectable(s):Array.isArray(s)?s.length>0?s.join(", "):e.config.placeholderValue:String(s);"string"==typeof i&&i.length>150&&(i=i.substring(0,150)+"..."),o+=a(n,i||e.config.placeholderValue)}}else o+="<div>No further detailed properties found or unexpected response format.</div>";o+=`\n            <div class="mt-3 grid grid-cols-2 gap-4">\n              <button class="btn btn-base btn-primary" data-action="edit-zone" data-uuid="${s}">\n                <i class="fas fa-edit mr-1"></i> Edit Settings\n              </button>\n            </div>\n          `,n.innerHTML=o}catch(e){console.error(`Error loading details for zone ${s}:`,e),n.innerHTML='<p class="text-danger">Error loading details. Check console.</p>'}}},fetchAndOpenEditZoneModal:async function(t){if(e.elements.editZoneModal)try{await e.zones.fetchCustomTemplates();const n=await e.api.callApi(`/settings/get_zone/${t}`);n&&n.zone?(e.state.zones.originalFullDataForEdit=n,e.zones.populateEditZoneModal(n.zone,t),e.elements.submitEditZoneBtn?e.elements.submitEditZoneBtn.disabled=!1:console.error("CPManager.elements.submitEditZoneBtn not found when trying to enable it in fetchAndOpenEditZoneModal."),e.elements.cancelEditZoneBtn&&(e.elements.cancelEditZoneBtn.disabled=!1),e.elements.editZoneModal.classList.remove("hidden"),e.elements.editZoneModal.classList.add("flex"),e.elements.zoneEditDescriptionInput&&e.elements.zoneEditDescriptionInput.focus()):(e.ui.showToast(`Could not load details for zone ${t}. API response issue.`,"error"),e.state.zones.originalFullDataForEdit=null)}catch(t){e.state.zones.originalFullDataForEdit=null,console.error("Error in fetchAndOpenEditZoneModal:",t)}else console.error("Edit Zone Modal element (CPManager.elements.editZoneModal) not found.")},populateEditZoneModal:function(t,n){const s=["editZoneUuidInput","editZoneModalTitleName","zoneEditDescriptionInput","zoneEditEnabledCheckbox","zoneEditEnabledText","zoneEditAllowedAddressesTextarea","zoneEditAllowedMACAddressesTextarea","zoneEditHardTimeoutInput","zoneEditIdleTimeoutInput","zoneEditConcurrentLoginsCheckbox","zoneEditConcurrentLoginsText","zoneEditTemplateSelect","zoneEditAuthServersSelect"];for(const t of s)if(!e.elements[t])return console.error(`Edit Zone Modal element missing: ${t}`),void e.ui.showToast("Cannot populate edit zone dialog: form elements missing.","error");const o=e=>{if("object"==typeof e&&null!==e&&!Array.isArray(e)){if(Object.values(e).some((e=>"object"==typeof e&&null!==e&&Object.prototype.hasOwnProperty.call(e,"selected")&&Object.prototype.hasOwnProperty.call(e,"value")))){const t=[];for(const n in e)"object"==typeof e[n]&&null!==e[n]&&Object.prototype.hasOwnProperty.call(e[n],"selected")&&Object.prototype.hasOwnProperty.call(e[n],"value")&&(1!==e[n].selected&&"1"!==e[n].selected&&!0!==e[n].selected||t.push(e[n].value));return t.join(",")}return""}return"string"==typeof e?e:""};e.elements.editZoneUuidInput.value=n,e.elements.editZoneModalTitleName.textContent=t.description||`Zone ${t.zoneid||n.substring(0,8)}`,e.elements.zoneEditDescriptionInput.value=t.description||"";const a="1"===t.enabled;e.elements.zoneEditEnabledCheckbox.checked=a,e.elements.zoneEditEnabledText.textContent=a?"Enabled":"Disabled",e.elements.zoneEditAllowedAddressesTextarea.value=o(t.allowedAddresses),e.elements.zoneEditAllowedMACAddressesTextarea.value=o(t.allowedMACAddresses),e.elements.zoneEditHardTimeoutInput.value=t.hardtimeout||"",e.elements.zoneEditIdleTimeoutInput.value=t.idletimeout||"";const i="1"===t.concurrentlogins;e.elements.zoneEditConcurrentLoginsCheckbox.checked=i,e.elements.zoneEditConcurrentLoginsText.textContent=i?"Allowed":"Disallowed";const r=e.elements.zoneEditTemplateSelect;r.innerHTML='<option value="">-- Default --</option>',e.state.zones.customTemplates.forEach((e=>{const t=document.createElement("option");t.value=e.uuid,t.textContent=e.name,r.appendChild(t)}));let l="";if("object"==typeof t.template&&null!==t.template){for(const e in t.template)if(t.template[e]&&(1===t.template[e].selected||"1"===t.template[e].selected)){l=e;break}}else"string"==typeof t.template&&t.template&&(l=t.template);l&&e.state.zones.customTemplates.some((e=>e.uuid===l))?r.value=l:r.value="";const c=e.elements.zoneEditAuthServersSelect;if(c.innerHTML="",t.authservers&&"object"==typeof t.authservers)for(const e in t.authservers)if(Object.prototype.hasOwnProperty.call(t.authservers,e)){const n=t.authservers[e],s=document.createElement("option");s.value=n.value,s.textContent=n.value,1!==n.selected&&"1"!==n.selected||(s.selected=!0),c.appendChild(s)}},saveZoneSettings:async function(){if(!e.elements.editZoneUuidInput||!e.elements.submitEditZoneBtn)return e.ui.showToast("Zone UUID is missing or save button not found. Cannot save.","error"),void console.error("Missing UUID input or submit button in saveZoneSettings.");const t=e.elements.editZoneUuidInput.value,n=Array.from(e.elements.zoneEditAuthServersSelect.selectedOptions).map((e=>e.value)),s={description:e.elements.zoneEditDescriptionInput.value.trim(),enabled:e.elements.zoneEditEnabledCheckbox.checked?"1":"0",allowedAddresses:e.elements.zoneEditAllowedAddressesTextarea.value.replace(/\s+/g,""),allowedMACAddresses:e.elements.zoneEditAllowedMACAddressesTextarea.value.replace(/\s+/g,"").toLowerCase(),hardtimeout:e.elements.zoneEditHardTimeoutInput.value.trim()||"0",idletimeout:e.elements.zoneEditIdleTimeoutInput.value.trim()||"0",concurrentlogins:e.elements.zoneEditConcurrentLoginsCheckbox.checked?"1":"0",template:e.elements.zoneEditTemplateSelect.value||"",authservers:n.join(",")},o={zone:s};e.elements.submitEditZoneBtn.disabled=!0,e.elements.submitEditZoneBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';try{const n=await e.api.callApi(`/settings/set_zone/${t}`,"POST",o);if(n&&"saved"===n.result){e.ui.showToast(`Zone settings updated for "${s.description||t.substring(0,8)}".`,"success"),e.ui.hideModal(e.elements.editZoneModal),e.state.zones.originalFullDataForEdit=null,e.state.zones.currentPage=1,await e.zones.loadZoneInfo(!0),e.ui.showToast("Applying changes by reconfiguring service...","info",7e3);const n=await e.api.callApi("/service/reconfigure","POST",{});n&&("ok"===n.status||n.message&&n.message.toLowerCase().includes("ok"))?e.ui.showToast("Captive portal service reconfigured successfully.","success"):e.ui.showToast(`Service reconfigure status: ${n?n.status||n.message||JSON.stringify(n):"Unknown"}. Manual check may be needed.`,"warning",1e4)}else{let t=`Failed to save zone settings: ${n?.message||n?.result||"Unknown API error"}`;if(n&&n.validations)for(const e in n.validations)t+=`\n- ${e}: ${n.validations[e]}`;e.ui.showToast(t,"error",1e4)}}catch(e){console.error("Error during saveZoneSettings:",e.message)}finally{e.elements.submitEditZoneBtn?(e.elements.submitEditZoneBtn.disabled=!1,e.elements.submitEditZoneBtn.innerHTML="Save Changes"):console.error("submitEditZoneBtn is null in finally block of saveZoneSettings. Cannot re-enable.")}},initializeZoneEventListeners:function(){e.elements.zoneListContainer&&e.elements.zoneListContainer.addEventListener("click",(async t=>{const n=t.target.closest('[data-action="edit-zone"]');if(n){t.stopPropagation();const s=n.dataset.uuid;return void(s?e.zones.fetchAndOpenEditZoneModal(s):console.error("Edit button clicked but no UUID found on dataset."))}const s=t.target.closest(".zone-info-card");if(s){const e=s.querySelector(".card-details-content"),t=s.querySelector(".zone-summary");this.handleZoneCardClick(s,e,t)}})),e.elements.submitEditZoneBtn?e.elements.submitEditZoneBtn.dataset.listenerAttached||(e.elements.submitEditZoneBtn.addEventListener("click",(function(){console.log("Save Changes button clicked (via initialized listener)."),e.zones.saveZoneSettings()})),e.elements.submitEditZoneBtn.dataset.listenerAttached="true"):console.error("Submit Edit Zone Button (CPManager.elements.submitEditZoneBtn) not found during initializeZoneEventListeners."),e.elements.cancelEditZoneBtn?e.elements.cancelEditZoneBtn.dataset.listenerAttached||(e.elements.cancelEditZoneBtn.addEventListener("click",(()=>{e.ui.hideModal(e.elements.editZoneModal),e.state.zones.originalFullDataForEdit=null})),e.elements.cancelEditZoneBtn.dataset.listenerAttached="true"):console.error("Cancel Edit Zone Button (CPManager.elements.cancelEditZoneBtn) not found during initializeZoneEventListeners."),e.elements.zoneEditEnabledCheckbox&&e.elements.zoneEditEnabledText&&(e.elements.zoneEditEnabledCheckbox.dataset.listenerAttached||(e.elements.zoneEditEnabledCheckbox.addEventListener("change",(function(){e.elements.zoneEditEnabledText.textContent=this.checked?"Enabled":"Disabled"})),e.elements.zoneEditEnabledCheckbox.dataset.listenerAttached="true")),e.elements.zoneEditConcurrentLoginsCheckbox&&e.elements.zoneEditConcurrentLoginsText&&(e.elements.zoneEditConcurrentLoginsCheckbox.dataset.listenerAttached||(e.elements.zoneEditConcurrentLoginsCheckbox.addEventListener("change",(function(){e.elements.zoneEditConcurrentLoginsText.textContent=this.checked?"Allowed":"Disallowed"})),e.elements.zoneEditConcurrentLoginsCheckbox.dataset.listenerAttached="true"))}}},3762:()=>{var e;(e=CPManager).tabs={setActiveTab:function(t,n=!1){if(e.elements.mainTabs&&e.elements.tabPanes[t]){switch(e.elements.mainTabs.querySelectorAll(".tab-btn").forEach((e=>{e.dataset.tab===t?(e.classList.add("active","text-primary","border-primary"),e.classList.remove("border-transparent","text-muted-foreground","hover:text-foreground","hover:border-muted"),e.setAttribute("aria-selected","true")):(e.classList.remove("active","text-primary","border-primary"),e.classList.add("border-transparent","text-muted-foreground","hover:text-foreground","hover:border-muted"),e.setAttribute("aria-selected","false"))})),Object.keys(e.elements.tabPanes).forEach((n=>{e.elements.tabPanes[n]&&(n===t?(e.elements.tabPanes[n].classList.remove("hidden"),e.elements.tabPanes[n].classList.add("active"),e.elements.tabPanes[n].removeAttribute("hidden")):(e.elements.tabPanes[n].classList.add("hidden"),e.elements.tabPanes[n].classList.remove("active"),e.elements.tabPanes[n].setAttribute("hidden","")))})),t){case"dashboard":e.dashboard.loadDashboardData(n);break;case"sessions":e.sessions.loadSessions(n);break;case"vouchers":e.vouchers.loadVoucherProviders(n);break;case"info":e.zones.loadZoneInfo(n);break;default:console.warn(`No specific load function for tab: ${t}`)}try{localStorage.setItem(e.config.localStorageKeys.activeTab,t)}catch(e){console.warn("Could not save active tab to localStorage:",e.message)}}else console.error(`Tab or tab pane not found for ID: ${t}`)},initializeTabs:function(){e.elements.mainTabs?e.elements.mainTabs.addEventListener("click",(t=>{const n=t.target.closest(".tab-btn");n&&n.dataset.tab&&(t.preventDefault(),e.tabs.setActiveTab(n.dataset.tab,!1))})):console.error("Main tabs container (mainTabs) not found.")}}},4528:()=>{var e;(e=CPManager).notifications={requestNotificationPermission:async function(){"Notification"in window?"granted"===await Notification.requestPermission()?(e.ui.showToast("Sign-in notifications enabled!","success"),e.state.currentApiKey&&e.state.currentApiSecret?(e.notifications.startSessionPolling(),e.state.notifications.consecutivePollErrors=0,e.notifications.updateNotificationToggleState(!0,!1)):(e.ui.showToast("API credentials not set. Cannot start polling.","warning"),e.notifications.updateNotificationToggleState(!1,!1))):(e.ui.showToast("Sign-in notifications permission denied.","warning"),e.notifications.stopSessionPolling(),e.notifications.updateNotificationToggleState(!1,!1)):e.ui.showToast("Browser does not support desktop notification","error")},checkForNewSessionsAndNotify:async function(){if("granted"!==Notification.permission)return e.notifications.stopSessionPolling(),void e.notifications.updateNotificationToggleState(!1,!1);try{const t=await e.api.callApi("/session/search");if(t&&Array.isArray(t.rows)){e.state.notifications.consecutivePollErrors=0,"true"===document.getElementById("notifications-toggle-btn")?.dataset.errorState&&e.notifications.updateNotificationToggleState(!0,!1);const n=new Set(t.rows.map((e=>e.sessionId)));if(e.state.notifications.isFirstPoll)return e.state.notifications.previousSessionIds=n,void(e.state.notifications.isFirstPoll=!1);const s=t.rows.filter((t=>!e.state.notifications.previousSessionIds.has(t.sessionId)));s.length>0&&s.forEach((t=>{const n=e.utils.getZoneDescription(t.zoneid)||`Zone ${t.zoneid}`,s=`User ${t.userName||t.ipAddress} connected to ${n}.`;navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"SHOW_NOTIFICATION",payload:{title:"New Captive Portal Sign-in",body:s,icon:"icons/icon-192x192.png",id:t.sessionId}})})),e.state.notifications.previousSessionIds=new Set(n)}}catch(t){console.error("Error polling for new sessions:",t.message),e.state.notifications.consecutivePollErrors++,e.state.notifications.consecutivePollErrors>=e.state.notifications.MAX_POLL_ERRORS_BEFORE_DISABLE&&(e.ui.showToast(`Disabling notifications due to ${e.state.notifications.MAX_POLL_ERRORS_BEFORE_DISABLE} API errors.`,"error",8e3),e.notifications.stopSessionPolling(),e.notifications.updateNotificationToggleState(!1,!0))}},startSessionPolling:function(){if(e.state.notifications.sessionPollIntervalId)return;if("granted"!==Notification.permission)return;e.state.notifications.isFirstPoll=!0,e.state.notifications.previousSessionIds.clear(),e.state.notifications.consecutivePollErrors=0;const t=document.hidden?e.state.notifications.POLLING_INTERVAL_HIDDEN_TAB:e.state.notifications.POLLING_INTERVAL;e.notifications.checkForNewSessionsAndNotify().finally((()=>{"granted"!==Notification.permission||e.state.notifications.sessionPollIntervalId||(e.state.notifications.sessionPollIntervalId=setInterval(e.notifications.checkForNewSessionsAndNotify,t))}))},stopSessionPolling:function(){e.state.notifications.sessionPollIntervalId&&(clearInterval(e.state.notifications.sessionPollIntervalId),e.state.notifications.sessionPollIntervalId=null)},updateNotificationToggleState:function(t,n=!1){const s=document.getElementById("notifications-toggle-btn");if(s){n?(s.innerHTML='<i class="fas fa-exclamation-triangle text-danger"></i>',s.setAttribute("aria-label","Notifications disabled (errors). Click to re-try."),s.dataset.errorState="true"):t?(s.innerHTML='<i class="fas fa-bell"></i>',s.setAttribute("aria-label","Disable sign-in notifications"),s.dataset.errorState="false"):(s.innerHTML='<i class="fas fa-bell-slash"></i>',s.setAttribute("aria-label","Enable sign-in notifications"),s.dataset.errorState="false");try{localStorage.setItem(e.config.localStorageKeys.signInNotificationsEnabled,t&&!n?"true":"false")}catch(e){console.warn("Could not save notification preference to localStorage:",e.message)}}},handleVisibilityChange:function(){(e.state.notifications.sessionPollIntervalId||"true"===localStorage.getItem(e.config.localStorageKeys.signInNotificationsEnabled))&&(e.state.notifications.sessionPollIntervalId&&(clearInterval(e.state.notifications.sessionPollIntervalId),e.state.notifications.sessionPollIntervalId=null),document.hidden?"granted"===Notification.permission&&(e.state.notifications.sessionPollIntervalId=setInterval(e.notifications.checkForNewSessionsAndNotify,e.state.notifications.POLLING_INTERVAL_HIDDEN_TAB)):"true"===localStorage.getItem(e.config.localStorageKeys.signInNotificationsEnabled)&&"granted"===Notification.permission&&e.notifications.startSessionPolling())},initializeNotifications:function(){const t=localStorage.getItem(e.config.localStorageKeys.signInNotificationsEnabled),n="granted"===Notification.permission;"true"===t&&n?(e.notifications.startSessionPolling(),e.notifications.updateNotificationToggleState(!0,!1)):"true"===t&&"default"===Notification.permission?e.notifications.requestNotificationPermission():e.notifications.updateNotificationToggleState(!1,!1),document.addEventListener("visibilitychange",e.notifications.handleVisibilityChange)}}},6232:()=>{!function(e){e.api={callApi:async function(t,n="GET",s=null){if(!e.config.baseUrl){const n="OPNsense API Base URL is not configured. Cannot make API call.";throw console.error(n,"Endpoint:",t),e.ui.showToast("API Base URL not set. Please configure in settings.","error",8e3),new Error(n)}const o=`${e.config.baseUrl}/api/captiveportal${t}`,a=new Headers;if(!e.state.currentApiKey||!e.state.currentApiSecret){const n="API Key or Secret is missing. Cannot make API call.";throw console.error(n,"Endpoint:",t),e.ui.showToast("API Key or Secret not set. Please configure in settings.","error"),new Error("API Key or Secret not set.")}a.append("Authorization","Basic "+btoa(e.state.currentApiKey+":"+e.state.currentApiSecret)),"POST"===n&&s&&a.append("Content-Type","application/json");const i={method:n,headers:a};s&&(i.body=JSON.stringify(s));try{const t=await fetch(o,i),s=await t.text();if(!t.ok){let a={message:`HTTP error! Status: ${t.status}.`};if(s)try{const e=JSON.parse(s);a.detail=e.message||e.detail||JSON.stringify(e)}catch(e){a.detail=s.substring(0,200)+(s.length>200?"...":""),console.error(`Failed to parse error response as JSON for ${n} ${o}:`,e,"Raw response:",s)}else a.detail=t.statusText||"No response body from server.";throw console.error("API Error:",n,o,t.status,a.detail,{response:t,responseText:s}),e.ui.showToast(`API Error: ${a.message} ${a.detail}`,"error"),new Error(`HTTP error! status: ${t.status}, message: ${a.detail}`)}if(204===t.status||!s)return console.info(`API Success: ${n} ${o} - No content or empty response.`),{status:"ok",message:`Operation successful (${204===t.status?"No Content":"Empty Response"})`};try{const t=JSON.parse(s);return t&&"error"===t.status?(console.warn(`API Operational Error for ${n} ${o}:`,t.message||"Error status received in JSON.",{jsonData:t}),e.ui.showToast(`API Operation Failed: ${t.message||"Error status received."}`,"warning")):console.info(`API Success: ${n} ${o}`,{jsonData:t}),t}catch(e){return t.ok&&(s.toLowerCase().includes("ok")||s.toLowerCase().includes("saved")||s.toLowerCase().includes("deleted")||s.toLowerCase().includes("success"))?(console.info(`API Success: ${n} ${o} - Text confirmation:`,s),{status:"ok_text",message:s}):(console.warn(`API Warning for ${n} ${o}: Successful response was not valid JSON and not recognized text. JSON parse error:`,e,"Content snippet:",s.substring(0,100)),{status:"ok_non_json",message:s})}}catch(t){if(console.error(`Fetch/Process Error for ${n} ${o}:`,t.message,t),!String(t.message).startsWith("HTTP error!")){let t="API request failed. This could be a network issue, or the OPNsense server might be unavailable or misconfigured.";e.config.baseUrl&&e.config.baseUrl.startsWith("http")&&!e.config.baseUrl.includes(window.location.origin)&&(t+=" If the app is hosted on a different domain than OPNsense, please check server's CORS configuration."),t+=" More details may be available in the browser's developer console.",e.ui.showToast(t,"error",8e3)}throw t}}}}(window.CPManager)},6511:(e,t,n)=>{"use strict";var s,o=n(7107),a=n(6188),i=n(6349),r=n(5708),l=(n(136),n(1549),n(6232),n(8212),n(3762),n(3159),n(5463));(s=CPManager).vouchers={selectedVouchers:new Set,currentlyVisibleVouchers:[],displayProviderZoneLinkage:async function(){const e=s.elements.providerZoneLinkageDetails;if(e){e.innerHTML='<p class="text-muted-foreground"><i class="fas fa-spinner fa-spin mr-2"></i>Loading linkage information...</p>';try{if(0===s.state.zones.allConfigured.length&&await s.zones.fetchAllZoneData(),0===s.state.vouchers.cachedProviders.length){const e=await s.api.callApi("/voucher/list_providers");s.state.vouchers.cachedProviders=Array.isArray(e)?e:[]}const t=s.state.vouchers.cachedProviders,n={};if(s.state.zones.allConfigured.length>0&&t.length>0)for(const e of s.state.zones.allConfigured)if(e.uuid)try{const o=await s.api.callApi(`/settings/get_zone/${e.uuid}`);if(o?.zone?.authservers){const a=o.zone.authservers;let i=[];if("object"!=typeof a||null===a||Array.isArray(a))"string"==typeof a&&""!==a.trim()?i=a.split(",").map((e=>e.trim())).filter(Boolean):Array.isArray(a)&&(i=a.map((e=>String(e).trim())).filter(Boolean));else{const e=s.utils.formatOpnsenseSelectable(a);e&&(i=e.split(",").map((e=>e.trim())).filter(Boolean))}const r=e.description||`Zone ${e.zoneid}`;i.forEach((e=>{t.includes(e)&&(n[e]||(n[e]=new Set),n[e].add(r))}))}}catch(t){console.warn(`Could not fetch details for zone ${e.uuid} for linkage card:`,t)}const o=Object.keys(n).filter((e=>n[e].size>0));if(0===o.length)e.innerHTML='<p class="text-muted-foreground">No voucher providers are currently linked to any active zones.</p>';else{let t='<ul class="space-y-3">';o.forEach((e=>{const s=Array.from(n[e]).map((e=>`<li><i class="fas fa-layer-group text-xs mr-1 text-muted"></i>${e}</li>`)).join("");t+=`<li class="border-b border-border border-dashed pb-2 last:border-b-0 last:pb-0"><span class="font-semibold text-foreground">${e}</span> is linked to:<ul class="list-none pl-4 mt-1 text-xs space-y-1">${s}</ul></li>`})),t+="</ul>",e.innerHTML=t}}catch(t){console.error("Error displaying provider-zone linkage:",t),e.innerHTML='<p class="text-danger">Could not load linkage information. Check console.</p>'}}else console.warn("Provider zone linkage details container not found.")},initializeProviderZoneLinkageCard:function(){const e=s.elements.providerZoneLinkageCard;if(!e||"true"===e.dataset.listenerAttached)return;const t=e.querySelector(".voucher-summary"),n=s.elements.providerZoneLinkageDetails;t&&n&&(t.addEventListener("click",(()=>{s.ui.toggleCardDetails(e),n.classList.contains("expanded")&&n.innerHTML.includes("Loading")&&this.displayProviderZoneLinkage()})),t.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.click())})),e.dataset.listenerAttached="true")},loadVoucherProviders:async function(e=!1){if(!s.elements.voucherProviderSelect)return;s.state.vouchers.currentPage=1,this.initializeProviderZoneLinkageCard();const t=s.elements.providerZoneLinkageDetails;if(t&&t.classList.contains("expanded")&&e&&await this.displayProviderZoneLinkage(),!e&&s.state.vouchers.cachedProviders.length>0&&Date.now()-s.state.vouchers.lastFetchedProviders<60*s.config.inMemoryCacheTTLMinutes*1e3)return this.populateVoucherProviderSelect(s.state.vouchers.cachedProviders),void(s.elements.voucherProviderSelect.value&&this.handleProviderSelection(s.elements.voucherProviderSelect.value));s.elements.voucherProviderSelect.innerHTML='<option value="">Loading providers...</option>',s.elements.voucherGroupSelect&&(s.elements.voucherGroupSelect.innerHTML='<option value="">Select provider...</option>'),s.elements.voucherCardContainer&&s.ui.clearContainer(s.elements.voucherCardContainer,"voucher-pagination"),s.elements.voucherSearchInput&&(s.elements.voucherSearchInput.value=""),s.elements.voucherStateFilterSelect&&(s.elements.voucherStateFilterSelect.value=""),s.ui.disableVoucherActionButtons(!0,!0,!0),this.updateVoidSelectedButton();try{const e=await s.api.callApi("/voucher/list_providers");Array.isArray(e)?(s.state.vouchers.cachedProviders=e,s.state.vouchers.lastFetchedProviders=Date.now(),this.populateVoucherProviderSelect(e),t&&t.classList.contains("expanded")&&await this.displayProviderZoneLinkage()):(s.state.vouchers.cachedProviders=[],s.ui.showToast("Could not load voucher providers: unexpected format.","error"),console.error("Voucher providers API returned unexpected format:",e))}catch(e){s.state.vouchers.cachedProviders=[],s.elements.voucherProviderSelect.innerHTML='<option value="">Error loading providers.</option>',s.ui.showToast("Error loading voucher providers: "+e.message,"error"),console.error("Error fetching voucher providers:",e)}},populateVoucherProviderSelect:function(e){if(!s.elements.voucherProviderSelect)return;if(0===e.length)return s.elements.voucherProviderSelect.innerHTML='<option value="">No providers found.</option>',s.ui.showToast("No voucher providers configured on OPNsense.","warning"),s.ui.disableVoucherActionButtons(!0,!0,!0),void this.updateVoidSelectedButton();s.elements.voucherProviderSelect.innerHTML='<option value="">-- Select Provider --</option>';const t=localStorage.getItem(s.config.localStorageKeys.selectedVoucherProvider);let n=null;e.forEach((e=>{const o=document.createElement("option");o.value=e,o.textContent=e,s.elements.voucherProviderSelect.appendChild(o),e===t&&(n=t)})),1!==e.length||n?n?(s.elements.voucherProviderSelect.value=n,this.handleProviderSelection(n)):(s.ui.disableVoucherActionButtons(!0,!0,!0),this.updateVoidSelectedButton()):(s.elements.voucherProviderSelect.value=e[0],localStorage.setItem(s.config.localStorageKeys.selectedVoucherProvider,e[0]),this.handleProviderSelection(e[0]))},handleProviderSelection:function(e,t=!1){s.state.vouchers.currentPage=1,this.selectedVouchers.clear(),this.updateSelectAllUI([]),s.elements.voucherSearchInput&&(s.elements.voucherSearchInput.value=""),s.elements.voucherStateFilterSelect&&(s.elements.voucherStateFilterSelect.value=""),e?(localStorage.setItem(s.config.localStorageKeys.selectedVoucherProvider,e),this.loadVoucherGroups(e,t)):(localStorage.removeItem(s.config.localStorageKeys.selectedVoucherProvider),s.elements.voucherGroupSelect&&(s.elements.voucherGroupSelect.innerHTML='<option value="">Select provider...</option>'),s.elements.voucherCardContainer&&s.ui.clearContainer(s.elements.voucherCardContainer,"voucher-pagination"),s.ui.disableVoucherActionButtons(!0,!0,!0),this.updateVoidSelectedButton())},loadVoucherGroups:async function(e,t=!1){if(s.state.vouchers.currentPage=1,this.selectedVouchers.clear(),this.updateSelectAllUI([]),s.elements.voucherSearchInput&&(s.elements.voucherSearchInput.value=""),s.elements.voucherStateFilterSelect&&(s.elements.voucherStateFilterSelect.value=""),!e||!s.elements.voucherGroupSelect)return s.elements.voucherGroupSelect&&(s.elements.voucherGroupSelect.innerHTML='<option value="">Select provider...</option>'),s.elements.voucherCardContainer&&s.ui.clearContainer(s.elements.voucherCardContainer,"voucher-pagination"),s.ui.disableVoucherActionButtons(!0,!0,!0),void this.updateVoidSelectedButton();const n=e;if(!t&&s.state.vouchers.cachedGroups[n]&&Date.now()-s.state.vouchers.cachedGroupsTimestamps[n]<60*s.config.inMemoryCacheTTLMinutes*1e3)this.populateVoucherGroupSelect(e,s.state.vouchers.cachedGroups[n]);else{s.elements.voucherGroupSelect.innerHTML='<option value="">Loading groups...</option>',!s.elements.voucherCardContainer||s.state.vouchers.cachedData[`${e}_${s.elements.voucherGroupSelect.value}`]&&!t||s.ui.showSkeletonLoaders(s.elements.voucherCardContainer,1,'<div class="skeleton-card"></div>',"voucher-pagination"),s.ui.disableVoucherActionButtons(!1,!0,!0),this.updateVoidSelectedButton();try{const t=await s.api.callApi(`/voucher/list_voucher_groups/${e}`);Array.isArray(t)?(s.state.vouchers.cachedGroups[n]=t,s.state.vouchers.cachedGroupsTimestamps[n]=Date.now(),this.populateVoucherGroupSelect(e,t)):(s.state.vouchers.cachedGroups[n]=[],s.elements.voucherGroupSelect&&(s.elements.voucherGroupSelect.innerHTML='<option value="">Error: No groups data.</option>'),s.elements.voucherCardContainer&&s.ui.showNoDataMessage(s.elements.voucherCardContainer,"Error loading groups.","fas fa-exclamation-triangle","voucher-pagination"),s.ui.disableVoucherActionButtons(!1,!0,!0),this.updateVoidSelectedButton(),console.error("Voucher groups API returned unexpected format:",t))}catch(e){s.state.vouchers.cachedGroups[n]=[],s.elements.voucherGroupSelect&&(s.elements.voucherGroupSelect.innerHTML='<option value="">Error loading groups.</option>'),s.elements.voucherCardContainer&&s.ui.showNoDataMessage(s.elements.voucherCardContainer,"Error loading groups.","fas fa-exclamation-triangle","voucher-pagination"),s.ui.disableVoucherActionButtons(!1,!0,!0),this.updateVoidSelectedButton(),console.error("Error fetching voucher groups:",e)}}},populateVoucherGroupSelect:async function(e,t){if(!s.elements.voucherGroupSelect)return;s.state.vouchers.currentPage=1;const n=`${s.config.localStorageKeys.voucherGroupFilterPrefix}${e}`,o=localStorage.getItem(n)||"";s.elements.voucherGroupSelect.innerHTML='<option value="">-- Select a Group --</option>',t.length>0?(t.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s.elements.voucherGroupSelect.appendChild(t)})),o&&t.includes(o)?s.elements.voucherGroupSelect.value=o:o&&!t.includes(o)&&(s.elements.voucherGroupSelect.value="",localStorage.removeItem(n))):s.elements.voucherGroupSelect.value="",s.elements.voucherGroupSelect.value?(s.ui.disableVoucherActionButtons(!1,!1,!1),await this.loadVouchersForGroup(e,s.elements.voucherGroupSelect.value)):(s.elements.voucherCardContainer&&(0===t.length&&e?s.ui.showNoDataMessage(s.elements.voucherCardContainer,`No voucher groups for provider: <strong>${e}</strong>.`,"fas fa-folder-open","voucher-pagination"):s.ui.showNoDataMessage(s.elements.voucherCardContainer,"Select a group to see its vouchers.","fas fa-ticket-alt","voucher-pagination")),this.renderVouchers([],""),s.ui.disableVoucherActionButtons(!1,!0,!0),this.updateVoidSelectedButton())},loadVouchersForGroup:async function(e,t,n=!1){if(s.state.vouchers.currentPage=1,this.selectedVouchers.clear(),!e||!t||!s.elements.voucherCardContainer)return s.elements.voucherCardContainer&&s.ui.showNoDataMessage(s.elements.voucherCardContainer,"Provider or group not selected.","fas fa-info-circle","voucher-pagination"),s.state.vouchers.current=[],void this.renderVouchers([],t);const o=`${e}_${t}`,a=!n&&s.state.vouchers.cachedData[o]&&Date.now()-s.state.vouchers.cachedData[o].lastFetched<60*s.config.inMemoryCacheTTLMinutes*1e3;a||s.ui.showSkeletonLoaders(s.elements.voucherCardContainer,s.config.itemsPerPage,'<div class="skeleton-card"></div>',"voucher-pagination");try{if(a)s.state.vouchers.current=s.state.vouchers.cachedData[o].data;else{const n=await s.api.callApi(`/voucher/list_vouchers/${e}/${t}`),a=Array.isArray(n)?n:[];s.state.vouchers.cachedData[o]={data:a,lastFetched:Date.now()},s.state.vouchers.current=a}}catch(e){s.ui.showToast("Error loading vouchers for group: "+e.message,"error"),s.state.vouchers.current=[],s.state.vouchers.cachedData[o]&&(s.state.vouchers.cachedData[o].lastFetched=0),console.error("Error fetching vouchers for group:",e)}finally{this.applyVoucherFiltersAndRender(t)}},applyVoucherFiltersAndRender:function(e){if(!s.elements.voucherCardContainer)return;s.state.vouchers.currentPage=1;const t=s.elements.voucherSearchInput?s.elements.voucherSearchInput.value.toLowerCase():"",n=s.elements.voucherStateFilterSelect?s.elements.voucherStateFilterSelect.value:"";let o=s.state.vouchers.current;t&&(o=o.filter((e=>e.username&&e.username.toLowerCase().includes(t)))),n&&(o=o.filter((e=>e.state===n))),this.currentlyVisibleVouchers=o,this.renderVouchers(o,e)},renderVouchers:function(e,t){const n=s.elements.voucherCardContainer,o=s.elements.voucherSelectAllContainer;if(n&&o){if(s.ui.clearContainer(n,"voucher-pagination"),this.updateSelectAllUI(e),e.length>0?o.classList.remove("hidden"):o.classList.add("hidden"),!e||0===e.length){const e=s.elements.voucherSearchInput?.value,o=s.elements.voucherStateFilterSelect?.value;let a=t?`No vouchers found in group "<strong>${t}</strong>"`:"Select a group to see vouchers.";return t&&(e||o)?a+=" matching your filters.":t&&(a+="."),void s.ui.showNoDataMessage(n,a,"fas fa-folder-open","voucher-pagination")}e.slice((s.state.vouchers.currentPage-1)*s.config.itemsPerPage,s.state.vouchers.currentPage*s.config.itemsPerPage).forEach((e=>{const t=document.createElement("div");t.className="voucher-card cp-card";const o="valid"===e.state?"bg-success":"unused"===e.state?"bg-primary":"bg-danger",a=s.config.voucherStateMapping[e.state]||e.state,i=this.selectedVouchers.has(e.username),r="expired"===e.state,l=`<div class="flex-shrink-0"><input type="checkbox" class="voucher-select-checkbox form-checkbox" data-voucher-username="${e.username}" ${i?"checked":""} ${r?"disabled":""}></div>`,c=`voucher-summary-${e.username}`,d=`voucher-details-${e.username}`;t.innerHTML=`<div class="flex justify-between items-center mb-1">${l}<div class="flex items-center"><span class="info-tag ${o}" title="State: ${a}">${a}</span></div></div><div id="${c}" class="voucher-summary cursor-pointer pb-1" role="button" tabindex="0" aria-expanded="false"><div class="card-detail-row"><span class="card-label">Voucher Code</span><span class="card-value">${e.username}</span></div></div><div class="card-details-content max-h-0 overflow-hidden transition-all duration-300 ease-out text-sm space-y-1" id="${d}" aria-hidden="true"><div class="card-detail-row"><span class="card-label">Validity</span> <span class="card-value-secondary">${s.utils.formatDuration(e.validity,"seconds")}</span></div><div class="card-detail-row"><span class="card-label">Start Time</span> <span class="card-value-secondary">${s.utils.formatVoucherTimestamp(e.starttime)}</span></div><div class="card-detail-row"><span class="card-label">End Time</span> <span class="card-value-secondary">${s.utils.formatVoucherTimestamp(e.endtime)}</span></div><div class="card-detail-row"><span class="card-label">Expires At</span><span class="card-value-secondary">${e.expirytime&&0!==e.expirytime?s.utils.formatVoucherTimestamp(e.expirytime):"Never"}</span></div></div>`,n.appendChild(t)})),s.ui.renderPaginationControls(s.elements.voucherPaginationContainer,s.state.vouchers.currentPage,e.length,s.config.itemsPerPage,(n=>{s.state.vouchers.currentPage=n,this.renderVouchers(e,t)}))}},updateVoidSelectedButton:function(){const e=s.elements.voidSelectedVouchersBtn;if(!e)return;const t=this.selectedVouchers.size,n=s.elements.voucherProviderSelect&&s.elements.voucherProviderSelect.value,o=s.elements.voucherGroupSelect&&s.elements.voucherGroupSelect.value;e.innerHTML='<i class="fas fa-times-circle mr-2"></i>Void Selected',e.disabled=0===t||!n||!o},updateSelectAllUI:function(e=this.currentlyVisibleVouchers){const{voucherSelectAllContainer:t,voucherSelectAllCheckbox:n,voucherSelectedCountText:o}=s.elements;if(!t||!n||!o)return;this.updateVoidSelectedButton();const a=this.selectedVouchers.size;o.textContent=`(${a} voucher${1===a?"":"s"} selected)`;const i=e.filter((e=>"expired"!==e.state)),r=i.length>0&&i.every((e=>this.selectedVouchers.has(e.username)));n.checked=r,n.indeterminate=a>0&&!r,n.disabled=0===i.length},handleSelectAll:function(e){this.currentlyVisibleVouchers.filter((e=>"expired"!==e.state)).forEach((t=>{e?this.selectedVouchers.add(t.username):this.selectedVouchers.delete(t.username)})),this.renderVouchers(this.currentlyVisibleVouchers,s.elements.voucherGroupSelect.value)},handleVoidSelectedVouchers:async function(){const e=Array.from(this.selectedVouchers);if(0===e.length)return;const t=s.elements.voucherProviderSelect.value,n=s.elements.voucherGroupSelect.value;if(!t||!n)return void s.ui.showToast("Cannot void: Provider or Group not selected.","error");const o=`Are you sure you want to void the <strong>${e.length}</strong> selected voucher(s) from group "<strong>${n}</strong>"? This will mark them as expired.`;s.ui.showConfirmationModal("Confirm Void Selected",o,(async()=>{s.ui.showToast(`Voiding ${e.length} voucher(s)...`,"info",5e3);let o=0,a=0;const i=e.map((e=>s.api.callApi(`/voucher/expire_voucher/${t}`,"POST",{username:e}).then((e=>e&&"error"!==e.status?o++:a++)).catch((t=>{console.error(`Failed to void voucher ${e}:`,t),a++}))));await Promise.all(i);let r=o>0&&0===a?`Successfully voided all ${o} selected voucher(s).`:o>0&&a>0?`Voided ${o} voucher(s). Failed for ${a}.`:`Failed to void any of the ${a} selected voucher(s).`;s.ui.showToast(r,a>0?o>0?"warning":"error":"success"),this.selectedVouchers.clear(),this.updateVoidSelectedButton(),s.state.vouchers.currentPage=1,await this.loadVouchersForGroup(t,n,!0)}))},openGenerateVoucherModal:function(){if(!s.elements.generateVoucherModal||!s.elements.voucherProviderSelect)return;if(!s.elements.voucherProviderSelect.value)return void s.ui.showToast("Please select a voucher provider before generating vouchers.","error");s.elements.voucherGroupNameInput&&(s.elements.voucherGroupNameInput.value=""),s.elements.voucherCountSelect&&(s.elements.voucherCountSelect.value="10"),s.elements.voucherCountCustom&&(s.elements.voucherCountCustom.classList.add("hidden"),s.elements.voucherCountCustom.value="1"),s.elements.voucherLifetimeSelect&&(s.elements.voucherLifetimeSelect.value="240"),s.elements.voucherLifetimeCustom&&(s.elements.voucherLifetimeCustom.classList.add("hidden"),s.elements.voucherLifetimeCustom.value=""),s.elements.voucherUsageSelect&&(s.elements.voucherUsageSelect.value="0"),s.elements.voucherUsageCustom&&(s.elements.voucherUsageCustom.classList.add("hidden"),s.elements.voucherUsageCustom.value="");const e=document.querySelector('input[name="voucher-output-format"][value="card"]');e&&(e.checked=!0),s.elements.generateVoucherModal.classList.remove("hidden"),s.elements.generateVoucherModal.classList.add("flex"),s.elements.voucherCountSelect&&s.elements.voucherCountSelect.focus()},handleSubmitGenerateVoucher:async function(){if(!s.elements.voucherProviderSelect||!s.elements.submitGenerateVoucherBtn)return;const e=s.elements.voucherProviderSelect.value;if(!e)return void s.ui.showToast("Voucher provider not selected. Cannot generate vouchers.","error");let t,n,o="custom"===s.elements.voucherCountSelect.value?parseInt(s.elements.voucherCountCustom.value):parseInt(s.elements.voucherCountSelect.value);if(isNaN(o)||o<1)return void s.ui.showToast("Number of vouchers must be at least 1.","error");if("custom"===s.elements.voucherLifetimeSelect.value){const e=parseInt(s.elements.voucherLifetimeCustom.value);if(isNaN(e)||e<1)return void s.ui.showToast("Custom Validity (minutes) must be at least 1.","error");t=60*e}else t=60*parseInt(s.elements.voucherLifetimeSelect.value);if("custom"===s.elements.voucherUsageSelect.value){const e=parseInt(s.elements.voucherUsageCustom.value);if(isNaN(e)||e<0)return void s.ui.showToast("Custom Expires In (hours) must be non-negative.","error");n=3600*e}else{const e=parseInt(s.elements.voucherUsageSelect.value);if(isNaN(e))return void s.ui.showToast("Invalid Expires In selection.","error");n=3600*e}const a=new Date,i=`g${a.getFullYear()}${String(a.getMonth()+1).padStart(2,"0")}${String(a.getDate()).padStart(2,"0")}${String(a.getHours()).padStart(2,"0")}${String(a.getMinutes()).padStart(2,"0")}`,r=s.elements.voucherGroupNameInput.value.trim()||i,c={count:String(o),validity:String(t),expirytime:String(n),vouchergroup:r};s.elements.submitGenerateVoucherBtn.disabled=!0,s.elements.submitGenerateVoucherBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';try{const t=await s.api.callApi(`/voucher/generate_vouchers/${e}`,"POST",c);if(t&&Array.isArray(t)&&t.length>0&&t[0].username){s.state.vouchers.lastGenerated=t;const n=document.querySelector('input[name="voucher-output-format"]:checked').value,o=new l.uE({orientation:"portrait",unit:"mm",format:"a4"});"card"===n?this.generateVouchersAsCardPDF(s.state.vouchers.lastGenerated,r,o):"table"===n?this.generateVouchersAsTablePDF(s.state.vouchers.lastGenerated,r,o):"both"===n&&(this.generateVouchersAsCardPDF(s.state.vouchers.lastGenerated,r,o),o.addPage(),this.generateVouchersAsTablePDF(s.state.vouchers.lastGenerated,r,o));const a=(new Date).toISOString().slice(0,10).replace(/-/g,"");o.save(`${r}_${a}_vouchers.pdf`),s.ui.showToast("Vouchers PDF generated!","success"),s.ui.hideModal(s.elements.generateVoucherModal),s.state.vouchers.currentPage=1,await this.loadVoucherGroups(e,!0),s.elements.voucherGroupSelect&&(s.elements.voucherGroupSelect.value=r),await this.loadVouchersForGroup(e,r,!0)}else s.ui.showToast(`Failed to generate vouchers: ${t?.message||("error"===t?.status?"API error.":"Unknown error.")}`,"error"),console.error("Voucher generation API returned unexpected result:",t),s.state.vouchers.lastGenerated=[]}catch(e){s.state.vouchers.lastGenerated=[],s.ui.showToast("Error during voucher generation or PDF creation: "+e.message,"error"),console.error("Error generating vouchers:",e)}finally{s.elements.submitGenerateVoucherBtn.disabled=!1,s.elements.submitGenerateVoucherBtn.innerHTML="Generate"}},generateVouchersAsCardPDF:function(e,t,n){const o=n.internal.pageSize.height,a=n.internal.pageSize.width,i=(a-20-8)/3,r=(o-20-15-20)/6;let l=10;n.setFontSize(20),n.setFont("helvetica","bold"),n.text(`Vouchers for Group: ${t} (Card Style)`,a/2,l+5,{align:"center"}),l+=15,e.forEach(((e,o)=>{const c=o%18;o>0&&0===c&&(n.addPage(),l=10,n.setFontSize(20),n.setFont("helvetica","bold"),n.text(`Vouchers for Group: ${t} (Card Style - Cont.)`,a/2,l+5,{align:"center"}),l+=15);const d=c%3,u=Math.floor(c/3),h=10+d*(i+4),p=l+u*(r+4);n.setDrawColor(200),n.roundedRect(h,p,i,r,2,2,"S"),n.setFontSize(8),n.setFont("helvetica","bold"),n.setTextColor(55,65,81),n.text("Voucher Code",h+i/2,p+6,{align:"center"}),n.setFontSize(16),n.setTextColor(29,78,216),n.text(e.username||s.config.placeholderValue,h+i/2,p+16,{align:"center"});let m=p+22;e.password&&(n.setFontSize(7),n.setTextColor(75,85,99),n.text(`Password: ${e.password}`,h+i/2,m,{align:"center"}),m+=4),n.setFontSize(6),n.setTextColor(107,114,128),n.text(`Validity: ${s.utils.formatDuration(e.validity,"seconds")}`,h+i/2,m+3,{align:"center"}),n.text(`Expires: ${e.expirytime&&0!==e.expirytime?s.utils.formatVoucherTimestamp(e.expirytime):"Never"}`,h+i/2,m+6,{align:"center"}),n.text(`Group: ${e.vouchergroup||s.config.placeholderValue}`,h+i/2,m+9,{align:"center"})}))},generateVouchersAsTablePDF:function(e,t,n){n.setFontSize(18),n.setFont("helvetica","bold"),n.text(`Voucher Table for Group: ${t}`,n.internal.pageSize.width/2,20,{align:"center"});const o=e.map((e=>[e.username||s.config.placeholderValue,e.password||s.config.placeholderValue,s.utils.formatDuration(e.validity,"seconds"),e.expirytime&&0!==e.expirytime?s.utils.formatVoucherTimestamp(e.expirytime):"Never",e.vouchergroup||s.config.placeholderValue]));(0,r.cs)(n,{startY:30,head:[["Voucher Code","Password","Validity","Expires","Group"]],body:o,theme:"striped",headStyles:{fillColor:[41,128,185],textColor:[255,255,255]},styles:{fontSize:8,cellPadding:2,valign:"middle",halign:"center"},columnStyles:{0:{cellWidth:30},1:{cellWidth:25},2:{cellWidth:25},3:{cellWidth:40},4:{cellWidth:"auto"}},didDrawPage:function(e){let t="Page "+n.internal.getNumberOfPages();n.setFontSize(8),n.text(t,n.internal.pageSize.width-e.settings.margin.right,n.internal.pageSize.height-5)}})},handleDropExpiredVouchers:async function(){if(!s.elements.voucherProviderSelect||!s.elements.voucherGroupSelect)return;const e=s.elements.voucherProviderSelect.value,t=s.elements.voucherGroupSelect.value;e?t?s.ui.showConfirmationModal("Drop Expired Vouchers?",`Remove all expired vouchers from group "<strong>${t}</strong>" for provider "<strong>${e}</strong>"?`,(async()=>{try{const n=await s.api.callApi(`/voucher/drop_expired_vouchers/${e}/${t}`,"POST",{});n&&"drop"===n.status?s.ui.showToast(`Expired vouchers from group "${t}" (Provider: ${e}) cleaned. Count: ${n.count||0}`,"success"):(s.ui.showToast(`Cleanup for group "${t}" (Provider: ${e}) processed. Status: ${n.status||"unknown"}. Count: ${n.count||0}`,"info"),console.warn("Drop expired vouchers API returned unexpected status:",n)),s.state.vouchers.currentPage=1,await this.loadVouchersForGroup(e,t,!0)}catch(e){s.ui.showToast("Error dropping expired vouchers: "+e.message,"error"),console.error("Error dropping expired vouchers:",e)}})):s.ui.showToast("Select voucher group.","error"):s.ui.showToast("Select voucher provider.","error")},handleDropVoucherGroup:async function(){if(!s.elements.voucherProviderSelect||!s.elements.voucherGroupSelect)return;const e=s.elements.voucherProviderSelect.value,t=s.elements.voucherGroupSelect.value;e?t?s.ui.showConfirmationModal("Drop Voucher Group?",`Delete entire voucher group "<strong>${t}</strong>" for provider "<strong>${e}</strong>"? This deletes all vouchers within.`,(async()=>{try{const n=await s.api.callApi(`/voucher/drop_voucher_group/${e}/${t}`,"POST",{});n&&"error"!==n.status?(s.ui.showToast(`Voucher group "${t}" (Provider: ${e}) deleted.`,"success"),s.state.vouchers.cachedGroups[e]&&(s.state.vouchers.cachedGroups[e]=s.state.vouchers.cachedGroups[e].filter((e=>e!==t))),delete s.state.vouchers.cachedData[`${e}_${t}`],s.state.vouchers.currentPage=1,await this.loadVoucherGroups(e,!0),s.elements.voucherGroupSelect&&!s.elements.voucherGroupSelect.value&&(s.elements.voucherCardContainer&&s.ui.showNoDataMessage(s.elements.voucherCardContainer,"Select a group to see its vouchers.","fas fa-ticket-alt","voucher-pagination"),s.state.vouchers.current=[]),s.ui.disableVoucherActionButtons(!1,!0,!0)):(s.ui.showToast(`Failed to delete voucher group "${t}". API: ${n?n.message:"Unknown error."}`,"error"),console.error("Drop voucher group API returned error or unexpected result:",n))}catch(e){s.ui.showToast("Error dropping voucher group: "+e.message,"error"),console.error("Error dropping voucher group:",e)}})):s.ui.showToast("Select voucher group to delete.","warning"):s.ui.showToast("Select voucher provider.","warning")},initializeVoucherEventListeners:function(){s.elements.voucherProviderSelect&&s.elements.voucherProviderSelect.addEventListener("change",(e=>this.handleProviderSelection(e.target.value))),s.elements.voucherGroupSelect&&s.elements.voucherGroupSelect.addEventListener("change",(async e=>{const t=s.elements.voucherProviderSelect?.value,n=e.target.value;if(this.selectedVouchers.clear(),this.updateSelectAllUI([]),s.elements.voucherSearchInput&&(s.elements.voucherSearchInput.value=""),s.elements.voucherStateFilterSelect&&(s.elements.voucherStateFilterSelect.value=""),!t)return s.ui.showToast("Select a voucher provider.","warning"),void(e.target.value="");const o=`${s.config.localStorageKeys.voucherGroupFilterPrefix}${t}`;localStorage.setItem(o,n),s.state.vouchers.currentPage=1,n?(await this.loadVouchersForGroup(t,n),s.ui.disableVoucherActionButtons(!1,!1,!1)):(s.elements.voucherCardContainer&&s.ui.showNoDataMessage(s.elements.voucherCardContainer,"Select a group to see its vouchers.","fas fa-ticket-alt","voucher-pagination"),s.state.vouchers.current=[],this.renderVouchers([],""),s.ui.disableVoucherActionButtons(!1,!0,!0))}));const e=()=>{const e=s.elements.voucherGroupSelect?.value;e&&this.applyVoucherFiltersAndRender(e)};s.elements.voucherSearchInput&&s.elements.voucherSearchInput.addEventListener("input",e),s.elements.voucherStateFilterSelect&&s.elements.voucherStateFilterSelect.addEventListener("change",e),s.elements.voidSelectedVouchersBtn&&s.elements.voidSelectedVouchersBtn.addEventListener("click",(()=>this.handleVoidSelectedVouchers())),s.elements.voucherSelectAllCheckbox&&s.elements.voucherSelectAllCheckbox.addEventListener("change",(e=>this.handleSelectAll(e.target.checked))),s.elements.voucherCardContainer&&s.elements.voucherCardContainer.addEventListener("click",(e=>{const t=e.target.closest(".voucher-select-checkbox");if(t)return t.checked?this.selectedVouchers.add(t.dataset.voucherUsername):this.selectedVouchers.delete(t.dataset.voucherUsername),void this.updateSelectAllUI();const n=e.target.closest(".voucher-card");n&&s.ui.toggleCardDetails(n)})),s.elements.createVouchersBtn&&s.elements.createVouchersBtn.addEventListener("click",(()=>this.openGenerateVoucherModal())),s.elements.dropExpiredVouchersBtn&&s.elements.dropExpiredVouchersBtn.addEventListener("click",(()=>this.handleDropExpiredVouchers())),s.elements.dropVoucherGroupBtn&&s.elements.dropVoucherGroupBtn.addEventListener("click",(()=>this.handleDropVoucherGroup())),s.elements.submitGenerateVoucherBtn&&s.elements.submitGenerateVoucherBtn.addEventListener("click",(()=>this.handleSubmitGenerateVoucher())),s.elements.cancelGenerateVoucherBtn&&s.elements.cancelGenerateVoucherBtn.addEventListener("click",(()=>s.ui.hideModal(s.elements.generateVoucherModal))),s.elements.voucherCountSelect&&s.elements.voucherCountCustom&&s.elements.voucherCountSelect.addEventListener("change",(e=>{s.elements.voucherCountCustom.classList.toggle("hidden","custom"!==e.target.value)})),s.elements.voucherLifetimeSelect&&s.elements.voucherLifetimeCustom&&s.elements.voucherLifetimeSelect.addEventListener("change",(e=>{s.elements.voucherLifetimeCustom.classList.toggle("hidden","custom"!==e.target.value)})),s.elements.voucherUsageSelect&&s.elements.voucherUsageCustom&&s.elements.voucherUsageSelect.addEventListener("change",(e=>{s.elements.voucherUsageCustom.classList.toggle("hidden","custom"!==e.target.value)}))}},s.state.vouchers.selectedVouchers||(s.state.vouchers.selectedVouchers=new Set),n(3415),function(e){e.dashboard={loadDashboardData:async function(t=!1){if(!(e.elements.dashboardStatsContainer&&e.elements.dataUsageCanvas&&e.elements.donutTotalData&&e.elements.uploadLegendValue&&e.elements.downloadLegendValue&&e.elements.uploadPercentageSpan&&e.elements.downloadPercentageSpan))return console.error("One or more dashboard elements are missing from the DOM."),void(e.elements.dashboardStatsContainer&&(e.elements.dashboardStatsContainer.innerHTML='<p class="text-danger col-span-full text-center">Error: Dashboard UI elements missing.</p>'));let n=null,s=null,o=0;const a=Date.now(),r=60*e.config.inMemoryCacheTTLMinutes*1e3,l=e.state.dashboard.apiDataCache.sessions&&a-e.state.dashboard.apiDataCache.sessionsLastFetched<r,c=null!==e.state.dashboard.apiDataCache.voucherStats&&void 0!==e.state.dashboard.apiDataCache.voucherStats.unusedVouchers&&a-e.state.dashboard.apiDataCache.voucherStatsLastFetched<r;!t&&l&&c?(console.log("Using cached dashboard API data."),n=e.state.dashboard.apiDataCache.sessions,s=e.state.dashboard.apiDataCache.voucherStats,0===e.state.zones.allConfigured.length&&await e.zones.fetchAllZoneData(),o=e.state.zones.allConfigured.length):(console.log("Fetching fresh dashboard data or cache expired/forced."),e.elements.dashboardStatsContainer.innerHTML='\n          <div class="skeleton-card"></div>\n          <div class="skeleton-card"></div>\n          <div class="skeleton-card"></div>\n                    <div class="skeleton-card"></div> ',e.elements.donutTotalData.textContent=e.config.placeholderValue,e.elements.uploadLegendValue.textContent=e.config.placeholderValue,e.elements.downloadLegendValue.textContent=e.config.placeholderValue,e.elements.uploadPercentageSpan.textContent="",e.elements.downloadPercentageSpan.textContent="",e.state.dashboard.chartInstance&&(e.state.dashboard.chartInstance.destroy(),e.state.dashboard.chartInstance=null));try{if(!n||t||!l){const t=await e.api.callApi("/session/search");n=t&&Array.isArray(t.rows)?t.rows:[],e.state.dashboard.apiDataCache.sessions=n,e.state.dashboard.apiDataCache.sessionsLastFetched=Date.now()}if(0===e.state.zones.allConfigured.length&&0===o&&await e.zones.fetchAllZoneData(),o=e.state.zones.allConfigured.length,!s||t||!c){let t=0,n=0,o=0,a=0,i=0;try{const s=await e.api.callApi("/voucher/list_providers");if(s&&Array.isArray(s)&&s.length>0){i=s.length;for(const i of s){const s=await e.api.callApi(`/voucher/list_voucher_groups/${i}`);if(s&&Array.isArray(s))for(const r of s){const s=await e.api.callApi(`/voucher/list_vouchers/${i}/${r}`);s&&Array.isArray(s)&&(t+=s.length,n+=s.filter((e=>"valid"===e.state)).length,o+=s.filter((e=>"expired"===e.state)).length,a+=s.filter((e=>"unused"===e.state)).length)}}}}catch(t){console.error("Error fetching voucher stats for dashboard:",t.message),e.ui.showToast("Could not load all voucher statistics for dashboard.","warning")}s={totalVouchers:t,activeVouchers:n,expiredVouchers:o,unusedVouchers:a,totalProviders:i},e.state.dashboard.apiDataCache.voucherStats=s,e.state.dashboard.apiDataCache.voucherStatsLastFetched=Date.now()}const a=n.length,{totalVouchers:r,activeVouchers:d,expiredVouchers:u,unusedVouchers:h,totalProviders:p}=s;let m=0,g=0;n.forEach((e=>{m+=e.bytes_in||0,g+=e.bytes_out||0}));let v=`\n          <div class="db-card" id="dashboard-active-sessions-card" title="Go to Sessions tab" role="button" tabindex="0">\n            <div class="db-card-number">${a}</div>\n            <div class="db-card-label">Active Sessions</div>\n          </div>\n          <div class="db-card" id="dashboard-zones-providers-card" title="Go to Zones or Vouchers tab" role="button" tabindex="0">\n            <div class="db-card-cols-2">\n              <div>\n                <div class="db-card-number">${o}</div>\n                <div class="db-card-label">Configured Zones</div>\n              </div>\n              <div>\n                <div class="db-card-number">${p}</div>\n                <div class="db-card-label">Voucher Providers</div>\n              </div>\n            </div>\n          </div>\n          <div class="db-card" id="dashboard-vouchers-card" title="Go to Vouchers tab" role="button" tabindex="0">\n            <div class="db-card-cols-2">\n              <div>\n                <div class="db-card-number">${r}</div>\n                <div class="db-card-label">Total Vouchers</div>\n              </div>\n              <div>\n                <div class="db-card-number text-success">${d}</div>\n                <div class="db-card-label">Active Vouchers</div>\n              </div>\n            </div>\n          </div>\n          <div class="db-card" id="dashboard-unused-expired-vouchers-card" title="Go to Vouchers tab" role="button" tabindex="0">\n              <div class="db-card-cols-2">\n                  <div>\n                      <div class="db-card-number text-primary">${h}</div>\n                      <div class="db-card-label">Unused Vouchers</div>\n                  </div>\n                  <div>\n                      <div class="db-card-number text-danger">${u}</div>\n                      <div class="db-card-label">Expired Vouchers</div>\n                  </div>\n              </div>\n          </div>\n        `;e.elements.dashboardStatsContainer.innerHTML=v,document.getElementById("dashboard-active-sessions-card")?.addEventListener("click",(()=>e.tabs.setActiveTab("sessions"))),document.getElementById("dashboard-zones-providers-card")?.addEventListener("click",(()=>e.tabs.setActiveTab("info"))),document.getElementById("dashboard-vouchers-card")?.addEventListener("click",(()=>e.tabs.setActiveTab("vouchers"))),document.getElementById("dashboard-unused-expired-vouchers-card")?.addEventListener("click",(()=>e.tabs.setActiveTab("vouchers"))),["dashboard-active-sessions-card","dashboard-zones-providers-card","dashboard-vouchers-card","dashboard-unused-expired-vouchers-card"].forEach((e=>{const t=document.getElementById(e);t&&t.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.click())}))}));const f=m+g;if(t||m!==e.state.dashboard.originalUploadBytes||g!==e.state.dashboard.originalDownloadBytes||!e.state.dashboard.chartInstance){e.dashboard.storeOriginalChartData(m,g,f),e.elements.donutTotalData&&(e.elements.donutTotalData.innerHTML=`\n              <span class="font-bold block text-lg">${e.utils.formatBytes(f)}</span>\n              <span class="text-xs text-muted-foreground">(100.0%)</span>`),e.elements.uploadLegendValue&&(e.elements.uploadLegendValue.textContent=e.utils.formatBytes(m)),e.elements.downloadLegendValue&&(e.elements.downloadLegendValue.textContent=e.utils.formatBytes(g)),e.elements.uploadPercentageSpan&&(e.elements.uploadPercentageSpan.textContent=`(${(f>0?m/f*100:0).toFixed(1)}%)`),e.elements.downloadPercentageSpan&&(e.elements.downloadPercentageSpan.textContent=`(${(f>0?g/f*100:0).toFixed(1)}%)`);const t=[m,g],n=getComputedStyle(document.documentElement),s=(e,t=1)=>{const s=n.getPropertyValue(e).trim().replace(/ /g,", ");return t<1?`hsla(${s}, ${t})`:`hsl(${s})`},o=s("--primary",.7),a=s("--success",.7),r=s("--primary"),l=s("--success"),c=s("--secondary"),d=s("--secondary-foreground"),u=s("--card");if(e.state.dashboard.chartInstance)e.state.dashboard.chartInstance.data.datasets[0].data=t,e.state.dashboard.chartInstance.options.plugins.tooltip.backgroundColor=c,e.state.dashboard.chartInstance.options.plugins.tooltip.titleColor=d,e.state.dashboard.chartInstance.options.plugins.tooltip.bodyColor=d,e.state.dashboard.chartInstance.options.borderColor=u,e.state.dashboard.chartInstance.update();else if(e.elements.dataUsageCanvas){const n=e.elements.dataUsageCanvas.getContext("2d");e.state.dashboard.chartInstance=new i.Ay(n,{type:"doughnut",data:{labels:["Client Upload","Client Download"],datasets:[{data:t,backgroundColor:[o,a],hoverBackgroundColor:[r,l],borderColor:u,borderWidth:2,hoverBorderWidth:3,hoverOffset:8}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"70%",animation:{animateScale:!0,animateRotate:!0,duration:1e3},layout:{padding:10},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:c,titleColor:d,bodyColor:d,displayColors:!1,callbacks:{label:function(t){let n=t.label||"";if(n&&(n+=": "),null!==t.parsed){n+=e.utils.formatBytes(t.parsed);const s=e.state.dashboard.originalTotalBytes;n+=s>0?` (${(t.parsed/s*100).toFixed(1)}%)`:" (0.0%)"}return n}}}}}})}}}catch(t){console.error("Error loading dashboard data:",t),e.elements.dashboardStatsContainer&&(e.elements.dashboardStatsContainer.innerHTML='<p class="text-danger col-span-full text-center">Error loading dashboard data. Check console.</p>'),e.elements.donutTotalData&&(e.elements.donutTotalData.textContent=e.config.placeholderValue),e.state.dashboard.apiDataCache.sessions=null,e.state.dashboard.apiDataCache.sessionsLastFetched=0,e.state.dashboard.apiDataCache.voucherStats=null,e.state.dashboard.apiDataCache.voucherStatsLastFetched=0}},storeOriginalChartData:function(t,n,s){e.state.dashboard.originalUploadBytes=t,e.state.dashboard.originalDownloadBytes=n,e.state.dashboard.originalTotalBytes=s},handleThemeChange:async function(){console.log("Dashboard: Handling theme change for chart update."),e.state.dashboard.chartInstance&&(e.state.dashboard.chartInstance.destroy(),e.state.dashboard.chartInstance=null,console.log("Dashboard chart instance destroyed for theme change.")),await e.dashboard.loadDashboardData(!0)},initializeDashboardEventListeners:function(){e.elements.legendItems&&e.elements.donutTotalData?e.elements.legendItems.forEach((t=>{t.addEventListener("mouseenter",(()=>{let n,s,o;const a=e.state.dashboard.originalTotalBytes;if(o="text-muted-foreground",t.textContent.includes("Client Upload")?(n=e.state.dashboard.originalUploadBytes,s="text-blue-500"):t.textContent.includes("Client Download")&&(n=e.state.dashboard.originalDownloadBytes,s="text-green-500"),void 0!==n&&e.elements.donutTotalData){let t=0;a>0&&(t=n/a*100),e.elements.donutTotalData.innerHTML=`\n              <span class="font-bold block text-lg ${s}">${e.utils.formatBytes(n)}</span>\n              <span class="text-xs text-muted-foreground">(${t.toFixed(1)}%)</span>`}})),t.addEventListener("mouseleave",(()=>{if(e.elements.donutTotalData){const t="text-muted-foreground";e.elements.donutTotalData.innerHTML=`\n              <span class="font-bold block text-lg">${e.utils.formatBytes(e.state.dashboard.originalTotalBytes)}</span>\n              <span class="text-xs ${t}">(100.0%)</span>`}}))})):console.warn("Dashboard legend items or donut total display element not found.")}}}(CPManager),n(4528),o.Yv.add(a.imB,a.oMq,a.PJS,a.XRN,a.iN5,a.z$e,a.zpE,a.iW_,a.s0Q,a.BeE,a.OQW,a.MT7,a.z1G,a.Jt$,a.Wzs,a.XkK,a.xiI,a.gdJ,a.Fny,a.qIE,a.yLE,a.$T_,a.Uj9,a.aN6,a.BF2,a.CN3),function(e){e.app={},e.app.applyTheme=function(t){let n=t;"system"===t&&(n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),"dark"===n?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),e.elements.themeToggleBtn&&(e.elements.themeToggleBtn.innerHTML="light"===t?'<i class="fas fa-sun"></i>':"dark"===t?'<i class="fas fa-moon"></i>':'<i class="fas fa-mobile-alt"></i>',e.elements.themeToggleBtn.setAttribute("aria-label","light"===t?"Switch to Dark Mode":"dark"===t?"Switch to System Preference":"Switch to Light Mode"))},e.app.toggleTheme=async function(){const t=localStorage.getItem(e.config.localStorageKeys.theme)||"system";let n;n="light"===t?"dark":"dark"===t?"system":"light",localStorage.setItem(e.config.localStorageKeys.theme,n),e.app.applyTheme(n),e.dashboard&&"function"==typeof e.dashboard.handleThemeChange&&(console.log("Theme setting changed by toggle, triggering dashboard theme handler."),await e.dashboard.handleThemeChange())},e.app.loadTheme=function(){const t=localStorage.getItem(e.config.localStorageKeys.theme)||"system";e.app.applyTheme(t),"system"===t&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(async()=>{"system"===localStorage.getItem(e.config.localStorageKeys.theme)&&(e.app.applyTheme("system"),e.dashboard&&"function"==typeof e.dashboard.handleThemeChange&&(console.log("System theme preference changed, triggering dashboard theme handler."),await e.dashboard.handleThemeChange()))}))},e.app.setCredentialEntryUIMode=function(t){const n=document.querySelector("nav"),s=e.elements.mainTabs?.closest(".mb-4.border-b"),o=document.getElementById("tabContent"),a=document.querySelector("footer"),i=e.elements.configInputSection,r=document.getElementById("main-content-scroll-area"),l=[n,s,o,a];t?(l.forEach((e=>e?.classList.add("hidden"))),i?.classList.remove("hidden"),r&&r.classList.add("flex","flex-col","items-center","justify-center","min-h-screen","p-4"),i&&(i.classList.add("max-w-lg","w-full","my-auto"),i.classList.remove("mb-4")),e.elements.saveApiCredsBtn&&(e.elements.saveApiCredsBtn.disabled=!1)):(l.forEach((e=>e?.classList.remove("hidden"))),i?.classList.add("hidden"),r&&r.classList.remove("flex","flex-col","items-center","justify-center","min-h-screen","p-4"),i&&(i.classList.remove("max-w-lg","w-full","my-auto"),i.classList.add("mb-4")),e.elements.saveApiCredsBtn&&(e.elements.saveApiCredsBtn.disabled=!0))},e.app.loadAppConfiguration=async function(){try{const t=await fetch("./app-config.json");if(!t.ok)throw new Error(`Failed to load app-config.json: ${t.statusText}`);const n=await t.json();n.apiBaseUrl?e.config.baseUrl=n.apiBaseUrl:(console.warn("apiBaseUrl not found in app-config.json. Will rely on user input for API Base URL."),e.config.baseUrl=""),void 0!==n.inMemoryCacheTTLMinutes&&"number"==typeof n.inMemoryCacheTTLMinutes&&(e.config.inMemoryCacheTTLMinutes=n.inMemoryCacheTTLMinutes),void 0!==n.itemsPerPage&&"number"==typeof n.itemsPerPage&&n.itemsPerPage>0&&(e.config.itemsPerPage=n.itemsPerPage),console.log("App config loaded. API Base URL:",e.config.baseUrl,"Cache TTL:",e.config.inMemoryCacheTTLMinutes,"Items/Page:",e.config.itemsPerPage)}catch(t){console.error("Error loading app configuration:",t),e.config.baseUrl="",e.elements.apiStatusFooterText&&(e.elements.apiStatusFooterText.textContent="App Config Load Failed!",e.elements.apiStatusFooterText.className="font-semibold text-red-500 dark:text-red-400"),e.ui.showToast(`Warning: App configuration file failed to load. Error: ${t.message}`,"warning",1e4)}},e.app.registerServiceWorker=function(){if("serviceWorker"in navigator){let e;navigator.serviceWorker.register("./sw.js").then((e=>console.log("Service worker registered:",e.scope))).catch((e=>console.error("Service worker registration failed:",e))),navigator.serviceWorker.addEventListener("controllerchange",(()=>{e||(window.location.reload(),e=!0)}))}},e.app.loadApiCredentials=function(){e.state.currentApiKey=localStorage.getItem(e.config.localStorageKeys.apiKey)||"",e.state.currentApiSecret=localStorage.getItem(e.config.localStorageKeys.apiSecret)||"",e.config.baseUrl=localStorage.getItem(e.config.localStorageKeys.apiBaseUrl)||e.config.baseUrl||"",e.elements.configApiKeyInput&&(e.elements.configApiKeyInput.value=e.state.currentApiKey),e.elements.configApiSecretInput&&(e.elements.configApiSecretInput.value=e.state.currentApiSecret),e.elements.configApiBaseUrlInput&&(e.elements.configApiBaseUrlInput.value=e.config.baseUrl)},e.app.saveApiCredentials=async function(){if(e.elements.configApiKeyInput&&e.elements.configApiSecretInput&&e.elements.configApiBaseUrlInput)if(e.state.currentApiKey=e.elements.configApiKeyInput.value.trim(),e.state.currentApiSecret=e.elements.configApiSecretInput.value.trim(),e.config.baseUrl=e.elements.configApiBaseUrlInput.value.trim(),e.config.baseUrl){try{new URL(e.config.baseUrl)}catch(t){return console.error("Invalid OPNsense API Base URL format:",t),void e.ui.showToast("Invalid OPNsense API Base URL format.","error")}if(e.state.currentApiKey&&e.state.currentApiSecret)try{localStorage.setItem(e.config.localStorageKeys.apiKey,e.state.currentApiKey),localStorage.setItem(e.config.localStorageKeys.apiSecret,e.state.currentApiSecret),localStorage.setItem(e.config.localStorageKeys.apiBaseUrl,e.config.baseUrl),e.ui.showToast("API credentials and Base URL saved.","success"),await e.app.initializeAppLogic();let t=localStorage.getItem(e.config.localStorageKeys.activeTab)||"dashboard";e.elements.tabPanes[t]||(t="dashboard"),console.log(`saveApiCredentials: Forcing refresh for tab: ${t}`),e.tabs.setActiveTab(t,!0)}catch(t){e.ui.showToast("Failed to save to local storage.","error"),console.error("Error saving to localStorage:",t)}else e.ui.showToast("API Key and Secret cannot be empty.","error")}else e.ui.showToast("OPNsense API Base URL cannot be empty.","error")},e.app.clearApiCredentials=function(){try{localStorage.removeItem(e.config.localStorageKeys.apiKey),localStorage.removeItem(e.config.localStorageKeys.apiSecret),localStorage.removeItem(e.config.localStorageKeys.apiBaseUrl)}catch(e){console.error("Error clearing localStorage:",e)}e.state.currentApiKey="",e.state.currentApiSecret="",e.config.baseUrl="",e.elements.configApiKeyInput&&(e.elements.configApiKeyInput.value=""),e.elements.configApiSecretInput&&(e.elements.configApiSecretInput.value=""),e.elements.configApiBaseUrlInput&&(e.elements.configApiBaseUrlInput.value=""),e.ui.showToast("API credentials cleared.","info"),e.app.setCredentialEntryUIMode(!0),document.querySelectorAll("button").forEach((t=>{t===e.elements.saveApiCredsBtn||t===e.elements.clearApiCredsBtn||t.id.startsWith("confirm-")||t.id.startsWith("cancel-")||t===e.elements.themeToggleBtn||(t.disabled=!0)})),document.querySelectorAll("input:not(#config-api-key):not(#config-api-secret):not(#config-api-base-url), select").forEach((e=>e.disabled=!0)),e.elements.mainTabs&&e.elements.mainTabs.querySelectorAll(".tab-btn").forEach((e=>e.classList.add("pointer-events-none"))),e.elements.apiStatusFooterText&&(e.elements.apiStatusFooterText.textContent="Credentials Cleared",e.elements.apiStatusFooterText.className="font-semibold text-yellow-500 dark:text-yellow-400"),e.elements.sessionCardContainer&&e.ui.clearContainer(e.elements.sessionCardContainer,"session-pagination"),e.elements.voucherCardContainer&&e.ui.clearContainer(e.elements.voucherCardContainer,"voucher-pagination"),e.elements.zoneListContainer&&e.ui.clearContainer(e.elements.zoneListContainer,"zone-pagination"),e.elements.dashboardStatsContainer&&e.ui.clearContainer(e.elements.dashboardStatsContainer),e.state.dashboard.chartInstance&&(e.state.dashboard.chartInstance.destroy(),e.state.dashboard.chartInstance=null),e.elements.donutTotalData&&(e.elements.donutTotalData.textContent=e.config.placeholderValue),e.state.sessions.all=[],e.state.sessions.currentPage=1,e.state.vouchers.cachedProviders=[],e.state.vouchers.cachedGroups={},e.state.vouchers.cachedData={},e.state.vouchers.currentPage=1,e.state.zones.allConfigured=[],e.state.zones.currentPage=1,e.state.dashboard.apiDataCache={sessions:null,voucherStats:null},e.dashboard.storeOriginalChartData(0,0,0)},e.app.checkApiStatusAndConfig=async function(){if(!e.config.baseUrl)return e.elements.apiStatusFooterText&&(e.elements.apiStatusFooterText.textContent="API Base URL Missing!",e.elements.apiStatusFooterText.className="font-semibold text-red-500 dark:text-red-400"),e.ui.showToast("OPNsense API Base URL is missing.","error",1e4),e.app.setCredentialEntryUIMode(!0),document.querySelectorAll('button:not(#save-api-creds-btn):not(#clear-api-creds-btn):not([id^="confirm-"]):not([id^="cancel-"]):not(#theme-toggle-btn)').forEach((e=>e.disabled=!0)),document.querySelectorAll("input:not(#config-api-key):not(#config-api-secret):not(#config-api-base-url), select").forEach((e=>e.disabled=!0)),e.elements.mainTabs&&e.elements.mainTabs.querySelectorAll(".tab-btn").forEach((e=>e.classList.add("pointer-events-none"))),!1;if(!e.state.currentApiKey||!e.state.currentApiSecret)return e.elements.apiStatusFooterText&&(e.elements.apiStatusFooterText.textContent="Credentials Missing!",e.elements.apiStatusFooterText.className="font-semibold text-yellow-500 dark:text-yellow-400"),e.app.setCredentialEntryUIMode(!0),document.querySelectorAll('button:not(#save-api-creds-btn):not(#clear-api-creds-btn):not([id^="confirm-"]):not([id^="cancel-"]):not(#theme-toggle-btn)').forEach((e=>e.disabled=!0)),document.querySelectorAll("input:not(#config-api-key):not(#config-api-secret):not(#config-api-base-url), select").forEach((e=>e.disabled=!0)),e.elements.mainTabs&&e.elements.mainTabs.querySelectorAll(".tab-btn").forEach((e=>e.classList.add("pointer-events-none"))),!1;e.app.setCredentialEntryUIMode(!1);try{await e.zones.fetchAllZoneData();const t=e.state.zones.allConfigured;return Array.isArray(t)?(e.elements.apiStatusFooterText&&(e.elements.apiStatusFooterText.textContent="Connected",e.elements.apiStatusFooterText.className="font-semibold text-green-600 dark:text-green-400"),!0):(e.elements.apiStatusFooterText&&(e.elements.apiStatusFooterText.textContent="Connection Problematic",e.elements.apiStatusFooterText.className="font-semibold text-yellow-500 dark:text-yellow-400"),console.warn("Initial API check (fetchAllZoneData) returned unexpected data format:",t),e.ui.showToast("API connection check returned unexpected data.","warning"),!1)}catch(t){return console.error("Initial API check (fetchAllZoneData) failed:",t),e.elements.apiStatusFooterText&&(e.elements.apiStatusFooterText.textContent="Connection Failed",e.elements.apiStatusFooterText.className="font-semibold text-red-500 dark:text-red-400"),t.message.includes("401")||t.message.includes("Unauthorized")?(e.app.setCredentialEntryUIMode(!0),e.ui.showToast("API authentication failed. Check API Key/Secret.","error",1e4)):t.message.includes("Failed to fetch")&&(e.ui.showToast("Cannot reach OPNsense API. Check Base URL & CORS.","error",1e4),e.app.setCredentialEntryUIMode(!0)),!1}},e.app.handleApplyCpConfiguration=async function(){if(!e.elements.applyCpConfigBtn)return;const t=e.elements.applyCpConfigBtn.innerHTML;e.elements.applyCpConfigBtn.disabled=!0,e.elements.applyCpConfigBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Applying...',e.ui.showToast("Applying Captive Portal configuration changes...","info");try{const t=await e.api.callApi("/service/reconfigure","POST",{});if(t&&("ok"===t.status||t.message&&t.message.toLowerCase().includes("ok")))e.ui.showToast("Captive portal service reconfigured successfully.","success");else{const n=t?t.status||t.message||JSON.stringify(t):"Unknown response";e.ui.showToast(`Service reconfigure status: ${n}`,"warning"),console.warn("Service reconfigure did not return 'ok' status:",t)}}catch(t){console.error("Error during manual reconfigure call:",t),e.ui.showToast(`Error applying Captive Portal configuration: ${t.message}`,"error")}finally{e.elements.applyCpConfigBtn.disabled=!1,e.elements.applyCpConfigBtn.innerHTML=t}},e.app.initializeAllEventListeners=function(){if(!e||"object"!=typeof e.elements||null===e.elements)return void console.error("CPManager.elements not initialized. Cannot attach listeners.");e.elements.themeToggleBtn&&e.elements.themeToggleBtn.addEventListener("click",e.app.toggleTheme),e.elements.saveApiCredsBtn&&e.elements.saveApiCredsBtn.addEventListener("click",e.app.saveApiCredentials),e.elements.clearApiCredsBtn&&e.elements.clearApiCredsBtn.addEventListener("click",e.app.clearApiCredentials),e.elements.apiStatusFooter&&(e.elements.apiStatusFooter.addEventListener("click",(()=>{e.app.setCredentialEntryUIMode(!0)})),e.elements.apiStatusFooter.classList.add("cursor-pointer","transition-opacity","duration-200","hover:opacity-75"),e.elements.apiStatusFooter.title="Click to reconfigure API Credentials"),e.elements.applyCpConfigBtn&&e.elements.applyCpConfigBtn.addEventListener("click",e.app.handleApplyCpConfiguration),e.elements.mainTabs?e.tabs.initializeTabs():console.warn("Main tabs container not found for event listener init."),e.elements.confirmationModal&&e.elements.confirmCancelBtn&&e.elements.confirmCancelBtn.addEventListener("click",(()=>{e.ui.hideModal(e.elements.confirmationModal),e.state.confirmCallback=null})),e.elements.confirmationModal&&e.elements.confirmProceedBtn&&e.elements.confirmProceedBtn.addEventListener("click",(()=>{e.state.confirmCallback&&e.state.confirmCallback(),e.ui.hideModal(e.elements.confirmationModal),e.state.confirmCallback=null})),document.querySelectorAll('.modal [id^="cancel-"]').forEach((t=>{t&&"true"!==t.dataset.specificHandlerAttached&&(t.addEventListener("click",(()=>{const n=t.closest(".modal");n&&(e.ui.hideModal(n),"editZoneModal"===n.id&&e.state.zones.originalFullDataForEdit&&(e.state.zones.originalFullDataForEdit=null))})),t.dataset.specificHandlerAttached="true")}));const t=document.getElementById("notifications-toggle-btn");if(t){let n,s=!1;const o=750,a=()=>{e.state.notifications.sessionPollIntervalId?(e.notifications.stopSessionPolling(),e.notifications.updateNotificationToggleState(!1),e.ui.showToast("Sign-in notifications disabled.","info")):e.notifications.requestNotificationPermission()},i=a=>{a.preventDefault(),s=!1,n=setTimeout((()=>{s=!0,"Disable sign-in notifications"===t.getAttribute("aria-label")?e.app.handleSendTestNotification():e.ui.showToast("Enable notifications first to send a test.","warning")}),o)},r=e=>{e.preventDefault(),clearTimeout(n),s||a(),s=!1},l=()=>{clearTimeout(n),s=!1};t.addEventListener("mousedown",i),t.addEventListener("mouseup",r),t.addEventListener("mouseleave",l),t.addEventListener("touchstart",i,{passive:!1}),t.addEventListener("touchend",r),t.addEventListener("touchcancel",l)}e.sessions&&e.sessions.initializeSessionEventListeners&&e.sessions.initializeSessionEventListeners(),e.vouchers&&e.vouchers.initializeVoucherEventListeners&&e.vouchers.initializeVoucherEventListeners(),e.zones&&e.zones.initializeZoneEventListeners&&e.zones.initializeZoneEventListeners(),e.dashboard&&e.dashboard.initializeDashboardEventListeners&&e.dashboard.initializeDashboardEventListeners()},e.app.initializeAppLogic=async function(){if(await e.app.checkApiStatusAndConfig()){document.querySelectorAll("button, input, select").forEach((t=>{(t.id.startsWith("config-api-")||t===e.elements.saveApiCredsBtn)&&t!==e.elements.clearApiCredsBtn&&t!==e.elements.themeToggleBtn||(t.disabled=!1)})),e.elements.mainTabs&&e.elements.mainTabs.querySelectorAll(".tab-btn").forEach((e=>e.classList.remove("pointer-events-none"))),e.elements.clearApiCredsBtn&&(e.elements.clearApiCredsBtn.disabled=!1),e.elements.themeToggleBtn&&(e.elements.themeToggleBtn.disabled=!1),o.tT.watch(),await e.sessions.fetchManagerSessionStatus(),e.ui.disableVoucherActionButtons(!1,!0,!0);let t=localStorage.getItem(e.config.localStorageKeys.activeTab)||"dashboard";const n=window.location.hash.substring(1);n&&e.elements.tabPanes[n]&&(t=n,window.history.replaceState&&window.history.replaceState(null,null,window.location.pathname+window.location.search)),e.elements.tabPanes[t]||(t="dashboard"),e.tabs.setActiveTab(t,!1),e.ui&&e.ui.initializeResizeHandler&&e.ui.initializeResizeHandler(),e.notifications.initializeNotifications()}else{document.querySelectorAll('button:not(#save-api-creds-btn):not(#clear-api-creds-btn):not([id^="confirm-"]):not([id^="cancel-"]):not(#theme-toggle-btn)').forEach((e=>e.disabled=!0)),document.querySelectorAll("input:not(#config-api-key):not(#config-api-secret):not(#config-api-base-url), select").forEach((e=>e.disabled=!0)),e.elements.mainTabs&&e.elements.mainTabs.querySelectorAll(".tab-btn").forEach((e=>e.classList.add("pointer-events-none"))),e.elements.clearApiCredsBtn&&(e.elements.clearApiCredsBtn.disabled=!1),e.elements.themeToggleBtn&&(e.elements.themeToggleBtn.disabled=!1),e.elements.applyCpConfigBtn&&(e.elements.applyCpConfigBtn.disabled=!0);const t=e.elements.tabPanes.dashboard;t&&!e.config.baseUrl&&document.querySelector("#config-input-section.hidden")&&(Object.values(e.elements.tabPanes).forEach((e=>{e&&(e.classList.add("hidden"),e.classList.remove("active"))})),t.classList.remove("hidden"),t.classList.add("active"),t.innerHTML='<div class="text-center p-8 text-red-500 dark:text-red-400"><i class="fas fa-exclamation-triangle fa-3x mb-3"></i><p>App config failed to load. Cannot connect.</p></div>')}},e.app.handleSendTestNotification=async function(){if(!("Notification"in window))return void e.ui.showToast("Browser does not support notifications.","error");if(!navigator.serviceWorker.controller)return void e.ui.showToast("Service worker not active.","warning");let t=Notification.permission;"default"===t&&(await e.notifications.requestNotificationPermission(),t=Notification.permission),"granted"===t?(navigator.serviceWorker.controller.postMessage({type:"SHOW_NOTIFICATION",payload:{title:"Test Notification",body:"Notifications are working!",icon:"icons/icon-192x192.png",id:`test-${Date.now()}`}}),e.ui.showToast("Test notification sent!","success")):"denied"===t&&e.ui.showToast("Notification permission denied. Please enable in browser settings.","error",7e3)},e.app.initializeApp=async function(){e.app.loadTheme();try{await e.app.loadAppConfiguration(),e.app.loadApiCredentials(),e.app.initializeAllEventListeners(),e.app.registerServiceWorker(),await e.app.initializeAppLogic()}catch(t){console.error("Failed to initialize the application:",t),e.elements.applyCpConfigBtn&&(e.elements.applyCpConfigBtn.disabled=!0);const n=e.elements.tabPanes.dashboard;n&&(Object.values(e.elements.tabPanes).forEach((e=>{e&&(e.classList.add("hidden"),e.classList.remove("active"))})),n.classList.remove("hidden"),n.classList.add("active"),n.innerHTML=`<div class="text-center p-8 text-red-500 dark:text-red-400"><i class="fas fa-exclamation-triangle fa-3x mb-3"></i><p>Critical Error: App init failed. ${t.message}</p></div>`),e.app.setCredentialEntryUIMode(!0)}},document.addEventListener("DOMContentLoaded",e.app.initializeApp)}(window.CPManager)},8212:()=>{var e;(e=CPManager).elements={themeToggleBtn:document.getElementById("theme-toggle-btn"),configInputSection:document.getElementById("config-input-section"),configApiBaseUrlInput:document.getElementById("config-api-base-url"),configApiKeyInput:document.getElementById("config-api-key"),configApiSecretInput:document.getElementById("config-api-secret"),saveApiCredsBtn:document.getElementById("save-api-creds-btn"),clearApiCredsBtn:document.getElementById("clear-api-creds-btn"),mainTabs:document.getElementById("mainTabs"),tabPanes:{dashboard:document.getElementById("dashboard-content"),sessions:document.getElementById("sessions-content"),vouchers:document.getElementById("vouchers-content"),info:document.getElementById("info-content")},sessionCardContainer:document.getElementById("session-card-container"),sessionPaginationContainer:document.getElementById("session-pagination"),sessionSearchInput:document.getElementById("session-search-input"),sessionZoneFilterSelect:document.getElementById("session-zone-filter-select"),findMySessionBtn:document.getElementById("find-my-session-btn"),disconnectSelectedSessionsBtn:document.getElementById("disconnect-selected-sessions-btn"),sessionSelectAllContainer:document.getElementById("session-select-all-container"),sessionSelectAllCheckbox:document.getElementById("session-select-all-checkbox"),sessionSelectedCountText:document.getElementById("session-selected-count-text"),voucherProviderSelect:document.getElementById("voucher-provider-select"),voucherGroupSelect:document.getElementById("voucher-group-select"),voucherCardContainer:document.getElementById("voucher-card-container"),voucherPaginationContainer:document.getElementById("voucher-pagination"),createVouchersBtn:document.getElementById("create-vouchers-btn"),dropVoucherGroupBtn:document.getElementById("drop-voucher-group-btn"),dropExpiredVouchersBtn:document.getElementById("drop-expired-vouchers-btn"),providerZoneLinkageCard:document.getElementById("provider-zone-linkage-card"),providerZoneLinkageDetails:document.getElementById("provider-zone-linkage-details"),voucherSearchInput:document.getElementById("voucher-search-input"),voucherStateFilterSelect:document.getElementById("voucher-state-filter-select"),voidSelectedVouchersBtn:document.getElementById("void-selected-vouchers-btn"),voucherSelectAllContainer:document.getElementById("voucher-select-all-container"),voucherSelectAllCheckbox:document.getElementById("voucher-select-all-checkbox"),voucherSelectedCountText:document.getElementById("voucher-selected-count-text"),generateVoucherModal:document.getElementById("generateVoucherModal"),voucherCountSelect:document.getElementById("voucher-count-select"),voucherCountCustom:document.getElementById("voucher-count-custom"),voucherLifetimeSelect:document.getElementById("voucher-lifetime-select"),voucherLifetimeCustom:document.getElementById("voucher-lifetime-custom"),voucherUsageSelect:document.getElementById("voucher-usage-select"),voucherUsageCustom:document.getElementById("voucher-usage-custom"),voucherGroupNameInput:document.getElementById("voucher-groupname"),cancelGenerateVoucherBtn:document.getElementById("cancel-generate-voucher-btn"),submitGenerateVoucherBtn:document.getElementById("submit-generate-voucher-btn"),zoneListContainer:document.getElementById("zone-list-container"),zonePaginationContainer:document.getElementById("zone-pagination"),editZoneModal:document.getElementById("editZoneModal"),editZoneModalTitleName:document.getElementById("editZoneModalTitleName"),editZoneUuidInput:document.getElementById("editZoneUuidInput"),zoneEditDescriptionInput:document.getElementById("zone-edit-description"),zoneEditEnabledCheckbox:document.getElementById("zone-edit-enabled"),zoneEditEnabledText:document.getElementById("zone-edit-enabled-text"),zoneEditAllowedAddressesTextarea:document.getElementById("zone-edit-allowedAddresses"),zoneEditAllowedMACAddressesTextarea:document.getElementById("zone-edit-allowedMACAddresses"),zoneEditHardTimeoutInput:document.getElementById("zone-edit-hardtimeout"),zoneEditIdleTimeoutInput:document.getElementById("zone-edit-idletimeout"),zoneEditConcurrentLoginsCheckbox:document.getElementById("zone-edit-concurrentlogins"),zoneEditConcurrentLoginsText:document.getElementById("zone-edit-concurrentlogins-text"),zoneEditTemplateSelect:document.getElementById("zone-edit-template"),zoneEditAuthServersSelect:document.getElementById("zone-edit-authservers"),cancelEditZoneBtn:document.getElementById("cancel-edit-zone-btn"),submitEditZoneBtn:document.getElementById("submit-edit-zone-btn"),applyCpConfigBtn:document.getElementById("apply-cp-config-btn"),confirmationModal:document.getElementById("confirmationModal"),confirmationTitle:document.getElementById("confirmationTitle"),confirmationMessage:document.getElementById("confirmationMessage"),confirmCancelBtn:document.getElementById("confirm-cancel-btn"),confirmProceedBtn:document.getElementById("confirm-proceed-btn"),toastNotification:document.getElementById("toast-notification"),toastMessage:document.getElementById("toast-message"),apiStatusFooter:document.getElementById("api-status-footer"),apiStatusFooterText:document.getElementById("api-status-footer")?.querySelector("span"),dashboardStatsContainer:document.getElementById("dashboard-stats-container"),dataUsageCanvas:document.getElementById("dataUsageCanvas"),donutTotalData:document.getElementById("donut-total-data"),uploadLegendValue:document.getElementById("upload-legend-value"),downloadLegendValue:document.getElementById("download-legend-value"),uploadPercentageSpan:document.getElementById("upload-percentage"),downloadPercentageSpan:document.getElementById("download-percentage"),legendItems:document.querySelectorAll(".legend-item")},e.ui||(e.ui={}),e.ui.paginationStates={},e.ui.resizeListenerAttached=!1,e.ui={...e.ui,showToast:function(t,n="info",s=5e3){const o=e.elements.toastNotification,a=e.elements.toastMessage;if(!o||!a)return console.warn("Toast elements not found in the DOM."),void alert(`Toast (${n}): ${t}`);switch(a.textContent=t,o.className="fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 max-w-xs z-50 print:hidden pointer-events-none",n){case"success":o.classList.add("bg-success");break;case"error":o.classList.add("bg-danger");break;case"warning":o.classList.add("bg-warning","text-foreground");break;default:o.classList.add("bg-secondary")}o.classList.remove("opacity-0"),o.classList.add("opacity-100"),o.classList.remove("pointer-events-none"),o.timer&&clearTimeout(o.timer),o.timer=setTimeout((()=>{o.classList.remove("opacity-100"),o.classList.add("opacity-0"),o.classList.add("pointer-events-none")}),s)},showConfirmationModal:function(t,n,s){const{confirmationModal:o,confirmationTitle:a,confirmationMessage:i}=e.elements;if(!o||!a||!i)return console.error("Confirmation modal elements not found."),void(confirm(t+"\n"+n.replace(/<br\/>/g,"\n").replace(/<strong>|<\/strong>/g,""))&&s&&s());a.textContent=t,i.innerHTML=n,e.state.confirmCallback=s,o.classList.remove("hidden"),o.classList.add("flex")},hideModal:function(e){e&&(e.classList.add("hidden"),e.classList.remove("flex"))},toggleCardDetails:function(e){if(!e)return;const t=e.querySelector(".card-details-content");if(!t)return;const n=t.classList.contains("expanded"),s=e.closest(".tab-pane");s&&s.querySelectorAll(".session-card, .voucher-card, .zone-info-card, #provider-zone-linkage-card").forEach((t=>{if(t!==e){const e=t.querySelector(".card-details-content");if(e&&e.classList.contains("expanded")){e.classList.remove("expanded"),e.setAttribute("aria-hidden","true");const n=t.querySelector(".voucher-summary, .session-summary, .zone-summary");if(n){n.setAttribute("aria-expanded","false");const e=n.querySelector("svg.svg-inline--fa.fa-chevron-down");e&&e.classList.remove("rotate-180")}}}}));const o=!n;t.classList.toggle("expanded",o),t.setAttribute("aria-hidden",String(!o));const a=e.querySelector(".voucher-summary, .session-summary, .zone-summary");if(a){a.setAttribute("aria-expanded",String(o));const e=a.querySelector("svg.svg-inline--fa.fa-chevron-down");e&&e.classList.toggle("rotate-180",o)}},disableVoucherActionButtons:function(t,n,s){const{createVouchersBtn:o,dropExpiredVouchersBtn:a,dropVoucherGroupBtn:i}=e.elements;o&&(o.disabled=t),a&&(a.disabled=n),i&&(i.disabled=s)},showSkeletonLoaders:function(e,t=2,n='<div class="skeleton-card"></div>',s=null){if(e){let s="";for(let e=0;e<t;e++)s+=n;e.innerHTML=s}if(s){const e=document.getElementById(s);e&&(e.innerHTML="")}},clearContainer:function(e,t=null){if(e&&(e.innerHTML=""),t){const e=document.getElementById(t);e&&(e.innerHTML="")}},showNoDataMessage:function(e,t="No data available.",n="fas fa-info-circle",s=null){if(e&&(e.innerHTML=`<div class="text-center p-4 text-gray-500 dark:text-slate-400"><i class="${n} fa-3x mb-2"></i><p>${t}</p></div>`),s){const e=document.getElementById(s);e&&(e.innerHTML="")}},renderPaginationControls:function(t,n,s,o,a){if(t&&t.id&&(e.ui.paginationStates[t.id]={container:t,currentPage:n,totalItems:s,itemsPerPage:o,onPageChangeCallback:a}),!t)return;if(t.innerHTML="",s<=o)return;const i=Math.ceil(s/o),r=document.createElement("nav");r.className="flex items-center justify-between px-4 py-3 sm:px-6 mt-6",r.setAttribute("aria-label","Pagination");const l=document.createElement("div");l.className="hidden sm:block";const c=(n-1)*o+1,d=Math.min(n*o,s);l.innerHTML=`<p class="text-sm text-gray-700 dark:text-slate-300">Showing <span class="font-medium text-gray-900 dark:text-white">${c}</span> to <span class="font-medium text-gray-900 dark:text-white">${d}</span> of <span class="font-medium text-gray-900 dark:text-white">${s}</span> results</p>`,r.appendChild(l);const u=document.createElement("div");u.className="flex-1 flex justify-between sm:justify-end";const h=document.createElement("div");h.className="relative z-0 inline-flex rounded-md shadow-sm -space-x-px",h.setAttribute("aria-label","Pagination");const p=(e,t,s=!1,o=!0,i=!1)=>{const r=document.createElement("button");r.innerHTML=e,r.setAttribute("aria-label",s?t<n?"Previous page":"Next page":`Go to page ${t}`);let l=s?" p-2":" px-4 py-2",c="";return i?(c="pagination-btn-current",r.setAttribute("aria-current","page")):c=o?"pagination-btn-hover":"pagination-btn-disabled",r.className=`relative inline-flex items-center text-sm font-medium pagination-btn-base ${l} ${c}`,o&&!i&&r.addEventListener("click",(()=>a(t))),r.disabled=!o,r},m=p('<i class="fas fa-chevron-left"></i>',n-1,!0,n>1);m.classList.add("rounded-l-md"),h.appendChild(m);let g=2;"undefined"!=typeof window&&window.innerWidth<480?g=0:"undefined"!=typeof window&&window.innerWidth<640&&(g=1);let v=[];if(i<=2*g+5)for(let e=1;e<=i;e++)v.push(e);else{v.push(1),n>g+2&&v.push("...");let e=Math.max(2,n-g),t=Math.min(i-1,n+g);n<=g+1&&(t=Math.min(i-1,1+2*g)),n>=i-g&&(e=Math.max(2,i-2*g));for(let n=e;n<=t;n++)n>0&&n<=i&&v.push(n);n<i-g-1&&v.push("..."),i>1&&v.push(i)}v=[...new Set(v)];for(let e=v.length-2;e>=1;e--)"..."===v[e]&&v[e-1]+1===v[e+1]&&v.splice(e,1);v.forEach((e=>{if("..."===e){const e=document.createElement("span");e.innerHTML="&hellip;",e.className="relative inline-flex items-center text-sm font-medium pagination-btn-base px-4 py-2",h.appendChild(e)}else h.appendChild(p(String(e),e,!1,!0,e===n))}));const f=p('<i class="fas fa-chevron-right"></i>',n+1,!0,n<i);f.classList.add("rounded-r-md"),h.appendChild(f),u.appendChild(h),r.appendChild(u),t.appendChild(r),n>1&&"function"==typeof t.scrollIntoView&&setTimeout((()=>{document.body.contains(t)&&null!==t.offsetParent&&t.scrollIntoView({behavior:"auto",block:"nearest"})}),100)},initializeResizeHandler:function(){if("undefined"!=typeof window&&!e.ui.resizeListenerAttached){let t;const n=()=>{let t=null;if(e.elements&&e.elements.tabPanes)for(const n in e.elements.tabPanes){const s=e.elements.tabPanes[n];if(s&&s.classList.contains("active")&&!s.classList.contains("hidden")){t=s.id;break}}if(t){let n;if(t.includes("sessions")?n="session-pagination":t.includes("vouchers")?n="voucher-pagination":t.includes("info")&&(n="zone-pagination"),n&&e.ui.paginationStates[n]){const t=e.ui.paginationStates[n];e.ui.renderPaginationControls(t.container,t.currentPage,t.totalItems,t.itemsPerPage,t.onPageChangeCallback)}}};window.addEventListener("resize",(()=>{clearTimeout(t),t=setTimeout(n,250)})),e.ui.resizeListenerAttached=!0}}}}},i={};function r(e){var t=i[e];if(void 0!==t)return t.exports;var n=i[e]={exports:{}};return a[e].call(n.exports,n,n.exports,r),n.exports}r.m=a,e=[],r.O=(t,n,s,o)=>{if(!n){var a=1/0;for(d=0;d<e.length;d++){for(var[n,s,o]=e[d],i=!0,l=0;l<n.length;l++)(!1&o||a>=o)&&Object.keys(r.O).every((e=>r.O[e](n[l])))?n.splice(l--,1):(i=!1,o<a&&(a=o));if(i){e.splice(d--,1);var c=s();void 0!==c&&(t=c)}}return t}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[n,s,o]},n=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,r.t=function(e,s){if(1&s&&(e=this(e)),8&s)return e;if("object"==typeof e&&e){if(4&s&&e.__esModule)return e;if(16&s&&"function"==typeof e.then)return e}var o=Object.create(null);r.r(o);var a={};t=t||[null,n({}),n([]),n(n)];for(var i=2&s&&e;"object"==typeof i&&!~t.indexOf(i);i=n(i))Object.getOwnPropertyNames(i).forEach((t=>a[t]=()=>e[t]));return a.default=()=>e,r.d(o,a),o},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,n)=>(r.f[n](e,t),t)),[])),r.u=e=>"js/chunks/"+e+"."+{354:"07739e33ca4d57a1527c",418:"888ff266ade1890514e5",661:"adcbd007cb0a19b0e935"}[e]+".js",r.miniCssF=e=>{},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s={},o="cpmanager:",r.l=(e,t,n,a)=>{if(s[e])s[e].push(t);else{var i,l;if(void 0!==n)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var u=c[d];if(u.getAttribute("src")==e||u.getAttribute("data-webpack")==o+n){i=u;break}}i||(l=!0,(i=document.createElement("script")).charset="utf-8",i.timeout=120,r.nc&&i.setAttribute("nonce",r.nc),i.setAttribute("data-webpack",o+n),i.src=e),s[e]=[t];var h=(t,n)=>{i.onerror=i.onload=null,clearTimeout(p);var o=s[e];if(delete s[e],i.parentNode&&i.parentNode.removeChild(i),o&&o.forEach((e=>e(n))),t)return t(n)},p=setTimeout(h.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=h.bind(null,i.onerror),i.onload=h.bind(null,i.onload),l&&document.head.appendChild(i)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var s=n.length-1;s>-1&&(!e||!/^http(s?):/.test(e));)e=n[s--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e+"../"})(),(()=>{var e={792:0};r.f.j=(t,n)=>{var s=r.o(e,t)?e[t]:void 0;if(0!==s)if(s)n.push(s[2]);else{var o=new Promise(((n,o)=>s=e[t]=[n,o]));n.push(s[2]=o);var a=r.p+r.u(t),i=new Error;r.l(a,(n=>{if(r.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var o=n&&("load"===n.type?"missing":n.type),a=n&&n.target&&n.target.src;i.message="Loading chunk "+t+" failed.\n("+o+": "+a+")",i.name="ChunkLoadError",i.type=o,i.request=a,s[1](i)}}),"chunk-"+t,t)}},r.O.j=t=>0===e[t];var t=(t,n)=>{var s,o,[a,i,l]=n,c=0;if(a.some((t=>0!==e[t]))){for(s in i)r.o(i,s)&&(r.m[s]=i[s]);if(l)var d=l(r)}for(t&&t(n);c<a.length;c++)o=a[c],r.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return r.O(d)},n=self.webpackChunkcpmanager=self.webpackChunkcpmanager||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var l=r.O(void 0,[399],(()=>r(6511)));l=r.O(l)})();
//# sourceMappingURL=main.e79d3f66ac32dc3de391.js.map